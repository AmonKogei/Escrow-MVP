8b865ac1c5a8d48b5ca693b404543da8
"use strict";
// src/lib/session.ts
// Small, runtime-compatible helpers to sign and verify a session cookie.
// This module intentionally does not import Prisma or other server-only libs so it
// can be used from middleware (Edge) and server routes.
Object.defineProperty(exports, "__esModule", { value: true });
exports.signSession = signSession;
exports.verifySession = verifySession;
const toHex = (buf) => Array.from(buf).map(b => b.toString(16).padStart(2, '0')).join('');
async function hmacSha256Hex(message, secret) {
    // Try Node's crypto first
    try {
        // eslint-disable-next-line @typescript-eslint/no-var-requires
        const { createHmac } = require('crypto');
        return createHmac('sha256', secret).update(message).digest('hex');
    }
    catch (e) {
        // Fallback to Web Crypto (Edge runtime)
        const enc = new TextEncoder();
        const key = await globalThis.crypto.subtle.importKey('raw', enc.encode(secret), { name: 'HMAC', hash: 'SHA-256' }, false, ['sign']);
        const sig = await globalThis.crypto.subtle.sign('HMAC', key, enc.encode(message));
        return toHex(new Uint8Array(sig));
    }
}
async function signSession(payload, secret) {
    if (!secret) {
        if (process.env.NODE_ENV === 'production') {
            throw new Error('SESSION_SECRET must be set in production');
        }
        console.warn('SESSION_SECRET not provided; using insecure fallback. Set SESSION_SECRET in env for production.');
        secret = 'dev-secret';
    }
    const str = JSON.stringify(payload);
    const encoded = encodeURIComponent(str);
    const sig = await hmacSha256Hex(encoded, secret);
    return `${encoded}.${sig}`;
}
async function verifySession(cookieValue, secret) {
    if (!cookieValue)
        return null;
    if (!secret) {
        if (process.env.NODE_ENV === 'production') {
            // Fail to verify in production without a secret
            return null;
        }
        // Insecure fallback for development/tests
        secret = 'dev-secret';
    }
    // tolerate cookie values where the signature may contain additional dots
    const parts = cookieValue.split('.');
    if (parts.length < 2)
        return null;
    const encoded = parts[0];
    const sig = parts.slice(1).join('.');
    // compute expected signature(s) for a few plausible input variants
    const expected = await hmacSha256Hex(encoded, secret);
    // also try on decoded payload (in case signing used the raw JSON rather than the encoded form)
    let expectedDecoded = null;
    try {
        const decodedStr = decodeURIComponent(encoded);
        expectedDecoded = await hmacSha256Hex(decodedStr, secret);
    }
    catch (e) {
        expectedDecoded = null;
    }
    // Timing-safe compare
    try {
        // Node crypto timingSafeEqual
        // Convert hex strings to buffers
        const bufSig = Buffer.from(sig, 'hex');
        const { timingSafeEqual } = require('crypto');
        // helper to compare a candidate expected sig against provided sig safely
        const compare = (candidateHex) => {
            if (!candidateHex)
                return false;
            try {
                const bufExpected = Buffer.from(candidateHex, 'hex');
                if (bufExpected.length !== bufSig.length)
                    return false;
                return timingSafeEqual(bufExpected, bufSig);
            }
            catch (e) {
                return false;
            }
        };
        const match = compare(expected) || compare(expectedDecoded);
        if (!match) {
            console.debug('verifySession: timingSafeEqual failed', {
                encoded: encoded.slice(0, 120),
                providedSig: sig,
                expectedSig: expected,
                expectedDecodedSig: expectedDecoded,
                secretPresent: !!process.env.SESSION_SECRET
            });
            return null;
        }
    }
    catch (e) {
        // Fallback: constant-time string compare
        let mismatch = 0;
        // fallback constant-time compare for string hexs
        // try to compare against both expected variants
        const tryCompareString = (candidate) => {
            if (!candidate)
                return false;
            if (candidate.length !== sig.length)
                return false;
            let mm = 0;
            for (let i = 0; i < candidate.length; i++) {
                mm |= candidate.charCodeAt(i) ^ sig.charCodeAt(i);
            }
            return mm === 0;
        };
        if (!tryCompareString(expected) && !tryCompareString(expectedDecoded)) {
            console.debug(`verifySession: fallback mismatch expected=${(expected || '').slice(0, 8)} got=${sig.slice(0, 8)} secretPresent=${!!process.env.SESSION_SECRET}`);
            return null;
        }
    }
    // debug: verification succeeded
    // console.debug(`verifySession: ok expected=${expected.slice(0,8)} got=${sig.slice(0,8)}`);
    try {
        const parsed = JSON.parse(decodeURIComponent(encoded));
        return parsed;
    }
    catch (e) {
        return null;
    }
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiQzpcXFVzZXJzXFxVU0VSXFxEb3dubG9hZHNcXEVzY3JvdyBNVlBcXHNyY1xcbGliXFxzZXNzaW9uLnRzIiwibWFwcGluZ3MiOiI7QUFBQSxxQkFBcUI7QUFDckIseUVBQXlFO0FBQ3pFLG1GQUFtRjtBQUNuRix3REFBd0Q7O0FBeUJ4RCxrQ0FZQztBQUVELHNDQWlGQztBQXRIRCxNQUFNLEtBQUssR0FBRyxDQUFDLEdBQWUsRUFBRSxFQUFFLENBQUMsS0FBSyxDQUFDLElBQUksQ0FBQyxHQUFHLENBQUMsQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDLEVBQUUsQ0FBQyxDQUFDLENBQUMsUUFBUSxDQUFDLEVBQUUsQ0FBQyxDQUFDLFFBQVEsQ0FBQyxDQUFDLEVBQUUsR0FBRyxDQUFDLENBQUMsQ0FBQyxJQUFJLENBQUMsRUFBRSxDQUFDLENBQUM7QUFFdEcsS0FBSyxVQUFVLGFBQWEsQ0FBQyxPQUFlLEVBQUUsTUFBYztJQUMxRCwwQkFBMEI7SUFDMUIsSUFBSSxDQUFDO1FBQ0gsOERBQThEO1FBQzlELE1BQU0sRUFBRSxVQUFVLEVBQUUsR0FBRyxPQUFPLENBQUMsUUFBUSxDQUFDLENBQUM7UUFDekMsT0FBTyxVQUFVLENBQUMsUUFBUSxFQUFFLE1BQU0sQ0FBQyxDQUFDLE1BQU0sQ0FBQyxPQUFPLENBQUMsQ0FBQyxNQUFNLENBQUMsS0FBSyxDQUFDLENBQUM7SUFDcEUsQ0FBQztJQUFDLE9BQU8sQ0FBQyxFQUFFLENBQUM7UUFDWCx3Q0FBd0M7UUFDeEMsTUFBTSxHQUFHLEdBQUcsSUFBSSxXQUFXLEVBQUUsQ0FBQztRQUM5QixNQUFNLEdBQUcsR0FBRyxNQUFPLFVBQWtCLENBQUMsTUFBTSxDQUFDLE1BQU0sQ0FBQyxTQUFTLENBQzNELEtBQUssRUFDTCxHQUFHLENBQUMsTUFBTSxDQUFDLE1BQU0sQ0FBQyxFQUNsQixFQUFFLElBQUksRUFBRSxNQUFNLEVBQUUsSUFBSSxFQUFFLFNBQVMsRUFBRSxFQUNqQyxLQUFLLEVBQ0wsQ0FBQyxNQUFNLENBQUMsQ0FDVCxDQUFDO1FBQ0Ys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S0FBSyxJQUFJLENBQUMsR0FBRyxDQUFDLEVBQUUsQ0FBQyxHQUFHLFNBQVMsQ0FBQyxNQUFNLEVBQUUsQ0FBQyxFQUFFLEVBQUUsQ0FBQztnQkFDMUMsRUFBRSxJQUFJLFNBQVMsQ0FBQyxVQUFVLENBQUMsQ0FBQyxDQUFDLEdBQUcsR0FBRyxDQUFDLFVBQVUsQ0FBQyxDQUFDLENBQUMsQ0FBQztZQUNwRCxDQUFDO1lBQ0QsT0FBTyxFQUFFLEtBQUssQ0FBQyxDQUFDO1FBQ2xCLENBQUMsQ0FBQztRQUNGLElBQUksQ0FBQyxnQkFBZ0IsQ0FBQyxRQUFRLENBQUMsSUFBSSxDQUFDLGdCQUFnQixDQUFDLGVBQWUsQ0FBQyxFQUFFLENBQUM7WUFDdEUsT0FBTyxDQUFDLEtBQUssQ0FBQyw2Q0FBNkMsQ0FBQyxRQUFRLElBQUUsRUFBRSxDQUFDLENBQUMsS0FBSyxDQUFDLENBQUMsRUFBQyxDQUFDLENBQUMsUUFBUSxHQUFHLENBQUMsS0FBSyxDQUFDLENBQUMsRUFBQyxDQUFDLENBQUMsa0JBQWtCLENBQUMsQ0FBQyxPQUFPLENBQUMsR0FBRyxDQUFDLGNBQWMsRUFBRSxDQUFDLENBQUM7WUFDNUosT0FBTyxJQUFJLENBQUM7UUFDZCxDQUFDO0lBQ0gsQ0FBQztJQUNELGdDQUFnQztJQUNoQyw0RkFBNEY7SUFDNUYsSUFBSSxDQUFDO1FBQ0gsTUFBTSxNQUFNLEdBQUcsSUFBSSxDQUFDLEtBQUssQ0FBQyxrQkFBa0IsQ0FBQyxPQUFPLENBQUMsQ0FBQyxDQUFDO1FBQ3ZELE9BQU8sTUFBTSxDQUFDO0lBQ2hCLENBQUM7SUFBQyxPQUFPLENBQUMsRUFBRSxDQUFDO1FBQ1gsT0FBTyxJQUFJLENBQUM7SUFDZCxDQUFDO0FBQ0gsQ0FBQyIsIm5hbWVzIjpbXSwic291cmNlcyI6WyJDOlxcVXNlcnNcXFVTRVJcXERvd25sb2Fkc1xcRXNjcm93IE1WUFxcc3JjXFxsaWJcXHNlc3Npb24udHMiXSwic291cmNlc0NvbnRlbnQiOlsiLy8gc3JjL2xpYi9zZXNzaW9uLnRzXHJcbi8vIFNtYWxsLCBydW50aW1lLWNvbXBhdGlibGUgaGVscGVycyB0byBzaWduIGFuZCB2ZXJpZnkgYSBzZXNzaW9uIGNvb2tpZS5cclxuLy8gVGhpcyBtb2R1bGUgaW50ZW50aW9uYWxseSBkb2VzIG5vdCBpbXBvcnQgUHJpc21hIG9yIG90aGVyIHNlcnZlci1vbmx5IGxpYnMgc28gaXRcclxuLy8gY2FuIGJlIHVzZWQgZnJvbSBtaWRkbGV3YXJlIChFZGdlKSBhbmQgc2VydmVyIHJvdXRlcy5cclxuXHJcbmNvbnN0IHRvSGV4ID0gKGJ1ZjogVWludDhBcnJheSkgPT4gQXJyYXkuZnJvbShidWYpLm1hcChiID0+IGIudG9TdHJpbmcoMTYpLnBhZFN0YXJ0KDIsICcwJykpLmpvaW4oJycpO1xyXG5cclxuYXN5bmMgZnVuY3Rpb24gaG1hY1NoYTI1NkhleChtZXNzYWdlOiBzdHJpbmcsIHNlY3JldDogc3RyaW5nKSB7XHJcbiAgLy8gVHJ5IE5vZGUncyBjcnlwdG8gZmlyc3RcclxuICB0cnkge1xyXG4gICAgLy8gZXNsaW50LWRpc2FibGUtbmV4dC1saW5lIEB0eXBlc2NyaXB0LWVzbGludC9uby12YXItcmVxdWlyZXNcclxuICAgIGNvbnN0IHsgY3JlYXRlSG1hYyB9ID0gcmVxdWlyZSgnY3J5cHRvJyk7XHJcbiAgICByZXR1cm4gY3JlYXRlSG1hYygnc2hhMjU2Jywgc2VjcmV0KS51cGRhdGUobWVzc2FnZSkuZGlnZXN0KCdoZXgnKTtcclxuICB9IGNhdGNoIChlKSB7XHJcbiAgICAvLyBGYWxsYmFjayB0byBXZWIgQ3J5cHRvIChFZGdlIHJ1bnRpbWUpXHJcbiAgICBjb25zdCBlbmMgPSBuZXcgVGV4dEVuY29kZXIoKTtcclxuICAgIGNvbnN0IGtleSA9IGF3YWl0IChnbG9iYWxUaGlzIGFzIGFueSkuY3J5cHRvLnN1YnRsZS5pbXBvcnRLZXkoXHJcbiAgICAgICdyYXcnLFxyXG4gICAgICBlbmMuZW5jb2RlKHNlY3JldCksXHJcbiAgICAgIHsgbmFtZTogJ0hNQUMnLCBoYXNoOiAnU0hBLTI1NicgfSxcclxuICAgICAgZmFsc2UsXHJcbiAgICAgIFsnc2lnbiddXHJcbiAgICApO1xyXG4gICAgY29uc3Qgc2lnID0gYXdhaXQgKGdsb2JhbFRoaXMgYXMgYW55KS5jcnlwdG8uc3VidGxlLnNpZ24oJ0hNQUMnLCBrZXksIGVuYy5lbmNvZGUobWVzc2FnZSkpO1xyXG4gICAgcmV0dXJuIHRvSGV4KG5ldyBVaW50OEFycmF5KHNpZykpO1xyXG4gIH1cclxufVxyXG5cclxuZXhwb3J0IGFzeW5jIGZ1bmN0aW9uIHNpZ25TZXNzaW9uKHBheWxvYWQ6IG9iamVjdCwgc2VjcmV0OiBzdHJpbmcpIHtcclxuICBpZiAoIXNlY3JldCkge1xyXG4gICAgaWYgKHByb2Nlc3MuZW52Lk5PREVfRU5WID09PSAncHJvZHVjdGlvbicpIHtcclxuICAgICAgdGhyb3cgbmV3IEVycm9yKCdTRVNTSU9OX1NFQ1JFVCBtdXN0IGJlIHNldCBpbiBwcm9kdWN0aW9uJyk7XHJcbiAgICB9XHJcbiAgICBjb25zb2xlLndhcm4oJ1NFU1NJT05fU0VDUkVUIG5vdCBwcm92aWRlZDsgdXNpbmcgaW5zZWN1cmUgZmFsbGJhY2suIFNldCBTRVNTSU9OX1NFQ1JFVCBpbiBlbnYgZm9yIHByb2R1Y3Rpb24uJyk7XHJcbiAgICBzZWNyZXQgPSAnZGV2LXNlY3JldCc7XHJcbiAgfVxyXG4gIGNvbnN0IHN0ciA9IEpTT04uc3RyaW5naWZ5KHBheWxvYWQpO1xyXG4gIGNvbnN0IGVuY29kZWQgPSBlbmNvZGVVUklDb21wb25lbnQoc3RyKTtcclxuICBjb25zdCBzaWcgPSBhd2FpdCBobWFjU2hhMjU2SGV4KGVuY29kZWQsIHNlY3JldCk7XHJcbiAgcmV0dXJuIGAke2VuY29kZWR9LiR7c2lnfWA7XHJcbn1cclxuXHJcbmV4cG9ydCBhc3luYyBmdW5jdGlvbiB2ZXJpZnlTZXNzaW9uKGNvb2tpZVZhbHVlOiBzdHJpbmcsIHNlY3JldDogc3RyaW5nKSB7XHJcbiAgaWYgKCFjb29raWVWYWx1ZSkgcmV0dXJuIG51bGw7XHJcbiAgaWYgKCFzZWNyZXQpIHtcclxuICAgIGlmIChwcm9jZXNzLmVudi5OT0RFX0VOViA9PT0gJ3Byb2R1Y3Rpb24nKSB7XHJcbiAgICAgIC8vIEZhaWwgdG8gdmVyaWZ5IGluIHByb2R1Y3Rpb24gd2l0aG91dCBhIHNlY3JldFxyXG4gICAgICByZXR1cm4gbnVsbDtcclxuICAgIH1cclxuICAgIC8vIEluc2VjdXJlIGZhbGxiYWNrIGZvciBkZXZlbG9wbWVudC90ZXN0c1xyXG4gICAgc2VjcmV0ID0gJ2Rldi1zZWNyZXQnO1xyXG4gIH1cclxuICAvLyB0b2xlcmF0ZSBjb29raWUgdmFsdWVzIHdoZXJlIHRoZSBzaWduYXR1cmUgbWF5IGNvbnRhaW4gYWRkaXRpb25hbCBkb3RzXHJcbiAgY29uc3QgcGFydHMgPSBjb29raWVWYWx1ZS5zcGxpdCgnLicpO1xyXG4gIGlmIChwYXJ0cy5sZW5ndGggPCAyKSByZXR1cm4gbnVsbDtcclxuICBjb25zdCBlbmNvZGVkID0gcGFydHNbMF07XHJcbiAgY29uc3Qgc2lnID0gcGFydHMuc2xpY2UoMSkuam9pbignLicpO1xyXG4gIC8vIGNvbXB1dGUgZXhwZWN0ZWQgc2lnbmF0dXJlKHMpIGZvciBhIGZldyBwbGF1c2libGUgaW5wdXQgdmFyaWFudHNcclxuICBjb25zdCBleHBlY3RlZCA9IGF3YWl0IGhtYWNTaGEyNTZIZXgoZW5jb2RlZCwgc2VjcmV0KTtcclxuICAvLyBhbHNvIHRyeSBvbiBkZWNvZGVkIHBheWxvYWQgKGluIGNhc2Ugc2lnbmluZyB1c2VkIHRoZSByYXcgSlNPTiByYXRoZXIgdGhhbiB0aGUgZW5jb2RlZCBmb3JtKVxyXG4gIGxldCBleHBlY3RlZERlY29kZWQ6IHN0cmluZyB8IG51bGwgPSBudWxsO1xyXG4gIHRyeSB7XHJcbiAgICBjb25zdCBkZWNvZGVkU3RyID0gZGVjb2RlVVJJQ29tcG9uZW50KGVuY29kZWQpO1xyXG4gICAgZXhwZWN0ZWREZWNvZGVkID0gYXdhaXQgaG1hY1NoYTI1NkhleChkZWNvZGVkU3RyLCBzZWNyZXQpO1xyXG4gIH0gY2F0Y2ggKGUpIHtcclxuICAgIGV4cGVjdGVkRGVjb2RlZCA9IG51bGw7XHJcbiAgfVxyXG4gIC8vIFRpbWluZy1zYWZlIGNvbXBhcmVcclxuICB0cnkge1xyXG4gICAgLy8gTm9kZSBjcnlwdG8gdGltaW5nU2FmZUVxdWFsXHJcbiAgICAvLyBDb252ZXJ0IGhleCBzdHJpbmdzIHRvIGJ1ZmZlcnNcclxuICAgIGNvbnN0IGJ1ZlNpZyA9IEJ1ZmZlci5mcm9tKHNpZywgJ2hleCcpO1xyXG4gICAgY29uc3QgeyB0aW1pbmdTYWZlRXF1YWwgfSA9IHJlcXVpcmUoJ2NyeXB0bycpO1xyXG4gICAgLy8gaGVscGVyIHRvIGNvbXBhcmUgYSBjYW5kaWRhdGUgZXhwZWN0ZWQgc2lnIGFnYWluc3QgcHJvdmlkZWQgc2lnIHNhZmVseVxyXG4gICAgY29uc3QgY29tcGFyZSA9IChjYW5kaWRhdGVIZXg6IHN0cmluZyB8IG51bGwpID0+IHtcclxuICAgICAgaWYgKCFjYW5kaWRhdGVIZXgpIHJldHVybiBmYWxzZTtcclxuICAgICAgdHJ5IHtcclxuICAgICAgICBjb25zdCBidWZFeHBlY3RlZCA9IEJ1ZmZlci5mcm9tKGNhbmRpZGF0ZUhleCwgJ2hleCcpO1xyXG4gICAgICAgIGlmIChidWZFeHBlY3RlZC5sZW5ndGggIT09IGJ1ZlNpZy5sZW5ndGgpIHJldHVybiBmYWxzZTtcclxuICAgICAgICByZXR1cm4gdGltaW5nU2FmZUVxdWFsKGJ1ZkV4cGVjdGVkLCBidWZTaWcpO1xyXG4gICAgICB9IGNhdGNoIChlKSB7XHJcbiAgICAgICAgcmV0dXJuIGZhbHNlO1xyXG4gICAgICB9XHJcbiAgICB9O1xyXG5cclxuICAgIGNvbnN0IG1hdGNoID0gY29tcGFyZShleHBlY3RlZCkgfHwgY29tcGFyZShleHBlY3RlZERlY29kZWQpO1xyXG4gICAgaWYgKCFtYXRjaCkge1xyXG4gICAgICBjb25zb2xlLmRlYnVnKCd2ZXJpZnlTZXNzaW9uOiB0aW1pbmdTYWZlRXF1YWwgZmFpbGVkJywge1xyXG4gICAgICAgIGVuY29kZWQ6IGVuY29kZWQuc2xpY2UoMCwgMTIwKSxcclxuICAgICAgICBwcm92aWRlZFNpZzogc2lnLFxyXG4gICAgICAgIGV4cGVjdGVkU2lnOiBleHBlY3RlZCxcclxuICAgICAgICBleHBlY3RlZERlY29kZWRTaWc6IGV4cGVjdGVkRGVjb2RlZCxcclxuICAgICAgICBzZWNyZXRQcmVzZW50OiAhIXByb2Nlc3MuZW52LlNFU1NJT05fU0VDUkVUXHJcbiAgICAgIH0pO1xyXG4gICAgICByZXR1cm4gbnVsbDtcclxuICAgIH1cclxuICB9IGNhdGNoIChlKSB7XHJcbiAgICAvLyBGYWxsYmFjazogY29uc3RhbnQtdGltZSBzdHJpbmcgY29tcGFyZVxyXG4gICAgbGV0IG1pc21hdGNoID0gMDtcclxuICAgIC8vIGZhbGxiYWNrIGNvbnN0YW50LXRpbWUgY29tcGFyZSBmb3Igc3RyaW5nIGhleHNcclxuICAgIC8vIHRyeSB0byBjb21wYXJlIGFnYWluc3QgYm90aCBleHBlY3RlZCB2YXJpYW50c1xyXG4gICAgY29uc3QgdHJ5Q29tcGFyZVN0cmluZyA9IChjYW5kaWRhdGU6IHN0cmluZyB8IG51bGwpID0+IHtcclxuICAgICAgaWYgKCFjYW5kaWRhdGUpIHJldHVybiBmYWxzZTtcclxuICAgICAgaWYgKGNhbmRpZGF0ZS5sZW5ndGggIT09IHNpZy5sZW5ndGgpIHJldHVybiBmYWxzZTtcclxuICAgICAgbGV0IG1tID0gMDtcclxuICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCBjYW5kaWRhdGUubGVuZ3RoOyBpKyspIHtcclxuICAgICAgICBtbSB8PSBjYW5kaWRhdGUuY2hhckNvZGVBdChpKSBeIHNpZy5jaGFyQ29kZUF0KGkpO1xyXG4gICAgICB9XHJcbiAgICAgIHJldHVybiBtbSA9PT0gMDtcclxuICAgIH07XHJcbiAgICBpZiAoIXRyeUNvbXBhcmVTdHJpbmcoZXhwZWN0ZWQpICYmICF0cnlDb21wYXJlU3RyaW5nKGV4cGVjdGVkRGVjb2RlZCkpIHtcclxuICAgICAgY29uc29sZS5kZWJ1ZyhgdmVyaWZ5U2Vzc2lvbjogZmFsbGJhY2sgbWlzbWF0Y2ggZXhwZWN0ZWQ9JHsoZXhwZWN0ZWR8fCcnKS5zbGljZSgwLDgpfSBnb3Q9JHtzaWcuc2xpY2UoMCw4KX0gc2VjcmV0UHJlc2VudD0keyEhcHJvY2Vzcy5lbnYuU0VTU0lPTl9TRUNSRVR9YCk7XHJcbiAgICAgIHJldHVybiBudWxsO1xyXG4gICAgfVxyXG4gIH1cclxuICAvLyBkZWJ1ZzogdmVyaWZpY2F0aW9uIHN1Y2NlZWRlZFxyXG4gIC8vIGNvbnNvbGUuZGVidWcoYHZlcmlmeVNlc3Npb246IG9rIGV4cGVjdGVkPSR7ZXhwZWN0ZWQuc2xpY2UoMCw4KX0gZ290PSR7c2lnLnNsaWNlKDAsOCl9YCk7XHJcbiAgdHJ5IHtcclxuICAgIGNvbnN0IHBhcnNlZCA9IEpTT04ucGFyc2UoZGVjb2RlVVJJQ29tcG9uZW50KGVuY29kZWQpKTtcclxuICAgIHJldHVybiBwYXJzZWQ7XHJcbiAgfSBjYXRjaCAoZSkge1xyXG4gICAgcmV0dXJuIG51bGw7XHJcbiAgfVxyXG59XHJcbiJdLCJ2ZXJzaW9uIjozfQ==
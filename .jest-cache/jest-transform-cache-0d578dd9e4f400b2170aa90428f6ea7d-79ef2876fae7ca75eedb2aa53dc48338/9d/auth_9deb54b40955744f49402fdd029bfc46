fa89cfac0b08ac1131be444739536211
"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.getSessionFromReq = getSessionFromReq;
const headers_1 = require("next/headers");
const session_1 = require("./session");
async function getSessionFromReq(req) {
    var _a, _b;
    try {
        // read cookie header
        let cookieHeader = '';
        if (req && 'headers' in req && req.headers) {
            const get = (_b = (_a = req.headers.get) === null || _a === void 0 ? void 0 : _a.bind(req.headers)) !== null && _b !== void 0 ? _b : undefined;
            if (get)
                cookieHeader = get('cookie') || '';
            else
                cookieHeader = req.headers.cookie || '';
        }
        else {
            // next server-side helper
            cookieHeader = (0, headers_1.cookies)().toString();
        }
        const cookieMap = {};
        cookieHeader.split(';').map(s => s.trim()).filter(Boolean).forEach(c => {
            const [k, ...rest] = c.split('=');
            cookieMap[k] = rest.join('=');
        });
        const raw = cookieMap['session'] || cookieMap['escrow_user'];
        if (!raw)
            return { user: null };
        const secret = process.env.SESSION_SECRET || '';
        const parsed = await (0, session_1.verifySession)(raw, secret);
        if (!parsed)
            return { user: null };
        const user = { id: parsed.id, email: parsed.email, role: (parsed.role || 'buyer') };
        return { user };
    }
    catch (e) {
        return { user: null };
    }
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiQzpcXFVzZXJzXFxVU0VSXFxEb3dubG9hZHNcXEVzY3JvdyBNVlBcXHNyY1xcbGliXFxhdXRoLnRzIiwibWFwcGluZ3MiOiI7O0FBSUEsOENBNkJDO0FBakNELDBDQUF1QztBQUN2Qyx1Q0FBMEM7QUFHbkMsS0FBSyxVQUFVLGlCQUFpQixDQUFDLEdBQStEOztJQUNyRyxJQUFJLENBQUM7UUFDSCxxQkFBcUI7UUFDckIsSUFBSSxZQUFZLEdBQUcsRUFBRSxDQUFDO1FBQ3RCLElBQUksR0FBRyxJQUFJLFNBQVMsSUFBSSxHQUFHLElBQUksR0FBRyxDQUFDLE9BQU8sRUFBRSxDQUFDO1lBQzNDLE1BQU0sR0FBRyxHQUFHLE1BQUEsTUFBQyxHQUFXLENBQUMsT0FBTyxDQUFDLEdBQUcsMENBQUUsSUFBSSxDQUFFLEdBQVcsQ0FBQyxPQUFPLENBQUMsbUNBQUksU0FBUyxDQUFDO1lBQzlFLElBQUksR0FBRztnQkFBRSxZQUFZLEdBQUcsR0FBRyxDQUFDLFFBQVEsQ0FBQyxJQUFJLEVBQUUsQ0FBQzs7Z0JBQ3ZDLFlBQVksR0FBSSxHQUFXLENBQUMsT0FBTyxDQUFDLE1BQU0sSUFBSSxFQUFFLENBQUM7UUFDeEQsQ0FBQzthQUFNLENBQUM7WUFDTiwwQkFBMEI7WUFDMUIsWUFBWSxHQUFHLElBQUEsaUJBQU8sR0FBRSxDQUFDLFFBQVEsRUFBRSxDQUFDO1FBQ3RDLENBQUM7UUFFRCxNQUFNLFNBQVMsR0FBMEIsRUFBRSxDQUFDO1FBQzVDLFlBQVksQ0FBQyxLQUFLLENBQUMsR0FBRyxDQUFDLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQyxFQUFFLENBQUMsQ0FBQyxDQUFDLElBQUksRUFBRSxDQUFDLENBQUMsTUFBTSxDQUFDLE9BQU8sQ0FBQyxDQUFDLE9BQU8sQ0FBQyxDQUFDLENBQUMsRUFBRTtZQUNyRSxNQUFNLENBQUMsQ0FBQyxFQUFFLEdBQUcsSUFBSSxDQUFDLEdBQUcsQ0FBQyxDQUFDLEtBQUssQ0FBQyxHQUFHLENBQUMsQ0FBQztZQUNsQyxTQUFTLENBQUMsQ0FBQyxDQUFDLEdBQUcsSUFBSSxDQUFDLElBQUksQ0FBQyxHQUFHLENBQUMsQ0FBQztRQUNoQyxDQUFDLENBQUMsQ0FBQztRQUVILE1BQU0sR0FBRyxHQUFHLFNBQVMsQ0FBQyxTQUFTLENBQUMsSUFBSSxTQUFTLENBQUMsYUFBYSxDQUFDLENBQUM7UUFDN0QsSUFBSSxDQUFDLEdBQUc7WUFBRSxPQUFPLEVBQUUsSUFBSSxFQUFFLElBQUksRUFBRSxDQUFDO1FBQ2hDLE1BQU0sTUFBTSxHQUFHLE9BQU8sQ0FBQyxHQUFHLENBQUMsY0FBYyxJQUFJLEVBQUUsQ0FBQztRQUNoRCxNQUFNLE1BQU0sR0FBRyxNQUFNLElBQUEsdUJBQWEsRUFBQyxHQUFHLEVBQUUsTUFBTSxDQUFDLENBQUM7UUFDaEQsSUFBSSxDQUFDLE1BQU07WUFBRSxPQUFPLEVBQUUsSUFBSSxFQUFFLElBQUksRUFBRSxDQUFDO1FBQ25DLE1BQU0sSUFBSSxHQUFnQixFQUFFLEVBQUUsRUFBRSxNQUFNLENBQUMsRUFBRSxFQUFFLEtBQUssRUFBRSxNQUFNLENBQUMsS0FBSyxFQUFFLElBQUksRUFBRSxDQUFDLE1BQU0sQ0FBQyxJQUFJLElBQUksT0FBTyxDQUFDLEVBQVMsQ0FBQztRQUN4RyxPQUFPLEVBQUUsSUFBSSxFQUFFLENBQUM7SUFDbEIsQ0FBQztJQUFDLE9BQU8sQ0FBQyxFQUFFLENBQUM7UUFDWCxPQUFPLEVBQUUsSUFBSSxFQUFFLElBQUksRUFBRSxDQUFDO0lBQ3hCLENBQUM7QUFDSCxDQUFDIiwibmFtZXMiOltdLCJzb3VyY2VzIjpbIkM6XFxVc2Vyc1xcVVNFUlxcRG93bmxvYWRzXFxFc2Nyb3cgTVZQXFxzcmNcXGxpYlxcYXV0aC50cyJdLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBjb29raWVzIH0gZnJvbSAnbmV4dC9oZWFkZXJzJztcclxuaW1wb3J0IHsgdmVyaWZ5U2Vzc2lvbiB9IGZyb20gJy4vc2Vzc2lvbic7XHJcbmltcG9ydCB0eXBlIHsgU2Vzc2lvbiwgU2Vzc2lvblVzZXIsIFVzZXJSb2xlIH0gZnJvbSAnLi4vdHlwZXMvc2Vzc2lvbic7XHJcblxyXG5leHBvcnQgYXN5bmMgZnVuY3Rpb24gZ2V0U2Vzc2lvbkZyb21SZXEocmVxOiBSZXF1ZXN0IHwgeyBoZWFkZXJzPzogUmVjb3JkPHN0cmluZywgc3RyaW5nPiB9IHwgdW5kZWZpbmVkKSA6IFByb21pc2U8U2Vzc2lvbj4ge1xyXG4gIHRyeSB7XHJcbiAgICAvLyByZWFkIGNvb2tpZSBoZWFkZXJcclxuICAgIGxldCBjb29raWVIZWFkZXIgPSAnJztcclxuICAgIGlmIChyZXEgJiYgJ2hlYWRlcnMnIGluIHJlcSAmJiByZXEuaGVhZGVycykge1xyXG4gICAgICBjb25zdCBnZXQgPSAocmVxIGFzIGFueSkuaGVhZGVycy5nZXQ/LmJpbmQoKHJlcSBhcyBhbnkpLmhlYWRlcnMpID8/IHVuZGVmaW5lZDtcclxuICAgICAgaWYgKGdldCkgY29va2llSGVhZGVyID0gZ2V0KCdjb29raWUnKSB8fCAnJztcclxuICAgICAgZWxzZSBjb29raWVIZWFkZXIgPSAocmVxIGFzIGFueSkuaGVhZGVycy5jb29raWUgfHwgJyc7XHJcbiAgICB9IGVsc2Uge1xyXG4gICAgICAvLyBuZXh0IHNlcnZlci1zaWRlIGhlbHBlclxyXG4gICAgICBjb29raWVIZWFkZXIgPSBjb29raWVzKCkudG9TdHJpbmcoKTtcclxuICAgIH1cclxuXHJcbiAgICBjb25zdCBjb29raWVNYXA6IFJlY29yZDxzdHJpbmcsc3RyaW5nPiA9IHt9O1xyXG4gICAgY29va2llSGVhZGVyLnNwbGl0KCc7JykubWFwKHMgPT4gcy50cmltKCkpLmZpbHRlcihCb29sZWFuKS5mb3JFYWNoKGMgPT4ge1xyXG4gICAgICBjb25zdCBbaywgLi4ucmVzdF0gPSBjLnNwbGl0KCc9Jyk7XHJcbiAgICAgIGNvb2tpZU1hcFtrXSA9IHJlc3Quam9pbignPScpO1xyXG4gICAgfSk7XHJcblxyXG4gICAgY29uc3QgcmF3ID0gY29va2llTWFwWydzZXNzaW9uJ10gfHwgY29va2llTWFwWydlc2Nyb3dfdXNlciddO1xyXG4gICAgaWYgKCFyYXcpIHJldHVybiB7IHVzZXI6IG51bGwgfTtcclxuICAgIGNvbnN0IHNlY3JldCA9IHByb2Nlc3MuZW52LlNFU1NJT05fU0VDUkVUIHx8ICcnO1xyXG4gICAgY29uc3QgcGFyc2VkID0gYXdhaXQgdmVyaWZ5U2Vzc2lvbihyYXcsIHNlY3JldCk7XHJcbiAgICBpZiAoIXBhcnNlZCkgcmV0dXJuIHsgdXNlcjogbnVsbCB9O1xyXG4gICAgY29uc3QgdXNlcjogU2Vzc2lvblVzZXIgPSB7IGlkOiBwYXJzZWQuaWQsIGVtYWlsOiBwYXJzZWQuZW1haWwsIHJvbGU6IChwYXJzZWQucm9sZSB8fCAnYnV5ZXInKSB9IGFzIGFueTtcclxuICAgIHJldHVybiB7IHVzZXIgfTtcclxuICB9IGNhdGNoIChlKSB7XHJcbiAgICByZXR1cm4geyB1c2VyOiBudWxsIH07XHJcbiAgfVxyXG59XHJcblxyXG4iXSwidmVyc2lvbiI6M30=
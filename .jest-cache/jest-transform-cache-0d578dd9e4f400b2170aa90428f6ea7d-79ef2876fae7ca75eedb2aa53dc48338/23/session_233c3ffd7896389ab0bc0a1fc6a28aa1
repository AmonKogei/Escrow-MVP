c2fc0cc6d28c5cb8c1b2e47c1ecf5f5c
"use strict";
// src/lib/session.ts
// Small, runtime-compatible helpers to sign and verify a session cookie.
// This module intentionally does not import Prisma or other server-only libs so it
// can be used from middleware (Edge) and server routes.
Object.defineProperty(exports, "__esModule", { value: true });
exports.signSession = signSession;
exports.verifySession = verifySession;
const toHex = (buf) => Array.from(buf).map(b => b.toString(16).padStart(2, '0')).join('');
async function hmacSha256Hex(message, secret) {
    // Try Node's crypto first
    try {
        // eslint-disable-next-line @typescript-eslint/no-var-requires
        const { createHmac } = require('crypto');
        return createHmac('sha256', secret).update(message).digest('hex');
    }
    catch (e) {
        // Fallback to Web Crypto (Edge runtime)
        const enc = new TextEncoder();
        const key = await globalThis.crypto.subtle.importKey('raw', enc.encode(secret), { name: 'HMAC', hash: 'SHA-256' }, false, ['sign']);
        const sig = await globalThis.crypto.subtle.sign('HMAC', key, enc.encode(message));
        return toHex(new Uint8Array(sig));
    }
}
async function signSession(payload, secret) {
    if (!secret) {
        if (process.env.NODE_ENV === 'production') {
            throw new Error('SESSION_SECRET must be set in production');
        }
        console.warn('SESSION_SECRET not provided; using insecure fallback. Set SESSION_SECRET in env for production.');
        secret = 'dev-secret';
    }
    const str = JSON.stringify(payload);
    const encoded = encodeURIComponent(str);
    const sig = await hmacSha256Hex(encoded, secret);
    return `${encoded}.${sig}`;
}
async function verifySession(cookieValue, secret) {
    if (!cookieValue)
        return null;
    if (!secret) {
        if (process.env.NODE_ENV === 'production') {
            // Fail to verify in production without a secret
            return null;
        }
        // Insecure fallback for development/tests
        secret = 'dev-secret';
    }
    const parts = cookieValue.split('.');
    if (parts.length !== 2)
        return null;
    const [encoded, sig] = parts;
    const expected = await hmacSha256Hex(encoded, secret);
    // Timing-safe compare
    try {
        // Node crypto timingSafeEqual
        // Convert hex strings to buffers
        const bufExpected = Buffer.from(expected, 'hex');
        const bufSig = Buffer.from(sig, 'hex');
        if (bufExpected.length !== bufSig.length)
            return null;
        // eslint-disable-next-line @typescript-eslint/no-var-requires
        const { timingSafeEqual } = require('crypto');
        if (!timingSafeEqual(bufExpected, bufSig)) {
            console.debug(`verifySession: timingSafeEqual failed expected=${expected.slice(0, 8)} got=${sig.slice(0, 8)} secretPresent=${!!process.env.SESSION_SECRET}`);
            return null;
        }
    }
    catch (e) {
        // Fallback: constant-time string compare
        let mismatch = 0;
        if (expected.length !== sig.length) {
            console.debug(`verifySession: length mismatch expected=${expected.length} got=${sig.length} secretPresent=${!!process.env.SESSION_SECRET}`);
            return null;
        }
        for (let i = 0; i < expected.length; i++) {
            mismatch |= expected.charCodeAt(i) ^ sig.charCodeAt(i);
        }
        if (mismatch !== 0) {
            console.debug(`verifySession: fallback mismatch expected=${expected.slice(0, 8)} got=${sig.slice(0, 8)} secretPresent=${!!process.env.SESSION_SECRET}`);
            return null;
        }
    }
    // debug: verification succeeded
    // console.debug(`verifySession: ok expected=${expected.slice(0,8)} got=${sig.slice(0,8)}`);
    try {
        const parsed = JSON.parse(decodeURIComponent(encoded));
        return parsed;
    }
    catch (e) {
        return null;
    }
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiQzpcXFVzZXJzXFxVU0VSXFxEb3dubG9hZHNcXEVzY3JvdyBNVlBcXHNyY1xcbGliXFxzZXNzaW9uLnRzIiwibWFwcGluZ3MiOiI7QUFBQSxxQkFBcUI7QUFDckIseUVBQXlFO0FBQ3pFLG1GQUFtRjtBQUNuRix3REFBd0Q7O0FBeUJ4RCxrQ0FZQztBQUVELHNDQWtEQztBQXZGRCxNQUFNLEtBQUssR0FBRyxDQUFDLEdBQWUsRUFBRSxFQUFFLENBQUMsS0FBSyxDQUFDLElBQUksQ0FBQyxHQUFHLENBQUMsQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDLEVBQUUsQ0FBQyxDQUFDLENBQUMsUUFBUSxDQUFDLEVBQUUsQ0FBQyxDQUFDLFFBQVEsQ0FBQyxDQUFDLEVBQUUsR0FBRyxDQUFDLENBQUMsQ0FBQyxJQUFJLENBQUMsRUFBRSxDQUFDLENBQUM7QUFFdEcsS0FBSyxVQUFVLGFBQWEsQ0FBQyxPQUFlLEVBQUUsTUFBYztJQUMxRCwwQkFBMEI7SUFDMUIsSUFBSSxDQUFDO1FBQ0gsOERBQThEO1FBQzlELE1BQU0sRUFBRSxVQUFVLEVBQUUsR0FBRyxPQUFPLENBQUMsUUFBUSxDQUFDLENBQUM7UUFDekMsT0FBTyxVQUFVLENBQUMsUUFBUSxFQUFFLE1BQU0sQ0FBQyxDQUFDLE1BQU0sQ0FBQyxPQUFPLENBQUMsQ0FBQyxNQUFNLENBQUMsS0FBSyxDQUFDLENBQUM7SUFDcEUsQ0FBQztJQUFDLE9BQU8sQ0FBQyxFQUFFLENBQUM7UUFDWCx3Q0FBd0M7UUFDeEMsTUFBTSxHQUFHLEdBQUcsSUFBSSxXQUFXLEVBQUUsQ0FBQztRQUM5QixNQUFNLEdBQUcsR0FBRyxNQUFPLFVBQWtCLENBQUMsTUFBTSxDQUFDLE1BQU0sQ0FBQyxTQUFTLENBQzNELEtBQUssRUFDTCxHQUFHLENBQUMsTUFBTSxDQUFDLE1BQU0sQ0FBQyxFQUNsQixFQUFFLElBQUksRUFBRSxNQUFNLEVBQUUsSUFBSSxFQUFFLFNBQVMsRUFBRSxFQUNqQyxLQUFLLEVBQ0wsQ0FBQyxNQUFNLENBQUMsQ0FDVCxDQUFDO1FBQ0Ys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XFVzZXJzXFxVU0VSXFxEb3dubG9hZHNcXEVzY3JvdyBNVlBcXHNyY1xcbGliXFxzZXNzaW9uLnRzIl0sInNvdXJjZXNDb250ZW50IjpbIi8vIHNyYy9saWIvc2Vzc2lvbi50c1xyXG4vLyBTbWFsbCwgcnVudGltZS1jb21wYXRpYmxlIGhlbHBlcnMgdG8gc2lnbiBhbmQgdmVyaWZ5IGEgc2Vzc2lvbiBjb29raWUuXHJcbi8vIFRoaXMgbW9kdWxlIGludGVudGlvbmFsbHkgZG9lcyBub3QgaW1wb3J0IFByaXNtYSBvciBvdGhlciBzZXJ2ZXItb25seSBsaWJzIHNvIGl0XHJcbi8vIGNhbiBiZSB1c2VkIGZyb20gbWlkZGxld2FyZSAoRWRnZSkgYW5kIHNlcnZlciByb3V0ZXMuXHJcblxyXG5jb25zdCB0b0hleCA9IChidWY6IFVpbnQ4QXJyYXkpID0+IEFycmF5LmZyb20oYnVmKS5tYXAoYiA9PiBiLnRvU3RyaW5nKDE2KS5wYWRTdGFydCgyLCAnMCcpKS5qb2luKCcnKTtcclxuXHJcbmFzeW5jIGZ1bmN0aW9uIGhtYWNTaGEyNTZIZXgobWVzc2FnZTogc3RyaW5nLCBzZWNyZXQ6IHN0cmluZykge1xyXG4gIC8vIFRyeSBOb2RlJ3MgY3J5cHRvIGZpcnN0XHJcbiAgdHJ5IHtcclxuICAgIC8vIGVzbGludC1kaXNhYmxlLW5leHQtbGluZSBAdHlwZXNjcmlwdC1lc2xpbnQvbm8tdmFyLXJlcXVpcmVzXHJcbiAgICBjb25zdCB7IGNyZWF0ZUhtYWMgfSA9IHJlcXVpcmUoJ2NyeXB0bycpO1xyXG4gICAgcmV0dXJuIGNyZWF0ZUhtYWMoJ3NoYTI1NicsIHNlY3JldCkudXBkYXRlKG1lc3NhZ2UpLmRpZ2VzdCgnaGV4Jyk7XHJcbiAgfSBjYXRjaCAoZSkge1xyXG4gICAgLy8gRmFsbGJhY2sgdG8gV2ViIENyeXB0byAoRWRnZSBydW50aW1lKVxyXG4gICAgY29uc3QgZW5jID0gbmV3IFRleHRFbmNvZGVyKCk7XHJcbiAgICBjb25zdCBrZXkgPSBhd2FpdCAoZ2xvYmFsVGhpcyBhcyBhbnkpLmNyeXB0by5zdWJ0bGUuaW1wb3J0S2V5KFxyXG4gICAgICAncmF3JyxcclxuICAgICAgZW5jLmVuY29kZShzZWNyZXQpLFxyXG4gICAgICB7IG5hbWU6ICdITUFDJywgaGFzaDogJ1NIQS0yNTYnIH0sXHJcbiAgICAgIGZhbHNlLFxyXG4gICAgICBbJ3NpZ24nXVxyXG4gICAgKTtcclxuICAgIGNvbnN0IHNpZyA9IGF3YWl0IChnbG9iYWxUaGlzIGFzIGFueSkuY3J5cHRvLnN1YnRsZS5zaWduKCdITUFDJywga2V5LCBlbmMuZW5jb2RlKG1lc3NhZ2UpKTtcclxuICAgIHJldHVybiB0b0hleChuZXcgVWludDhBcnJheShzaWcpKTtcclxuICB9XHJcbn1cclxuXHJcbmV4cG9ydCBhc3luYyBmdW5jdGlvbiBzaWduU2Vzc2lvbihwYXlsb2FkOiBvYmplY3QsIHNlY3JldDogc3RyaW5nKSB7XHJcbiAgaWYgKCFzZWNyZXQpIHtcclxuICAgIGlmIChwcm9jZXNzLmVudi5OT0RFX0VOViA9PT0gJ3Byb2R1Y3Rpb24nKSB7XHJcbiAgICAgIHRocm93IG5ldyBFcnJvcignU0VTU0lPTl9TRUNSRVQgbXVzdCBiZSBzZXQgaW4gcHJvZHVjdGlvbicpO1xyXG4gICAgfVxyXG4gICAgY29uc29sZS53YXJuKCdTRVNTSU9OX1NFQ1JFVCBub3QgcHJvdmlkZWQ7IHVzaW5nIGluc2VjdXJlIGZhbGxiYWNrLiBTZXQgU0VTU0lPTl9TRUNSRVQgaW4gZW52IGZvciBwcm9kdWN0aW9uLicpO1xyXG4gICAgc2VjcmV0ID0gJ2Rldi1zZWNyZXQnO1xyXG4gIH1cclxuICBjb25zdCBzdHIgPSBKU09OLnN0cmluZ2lmeShwYXlsb2FkKTtcclxuICBjb25zdCBlbmNvZGVkID0gZW5jb2RlVVJJQ29tcG9uZW50KHN0cik7XHJcbiAgY29uc3Qgc2lnID0gYXdhaXQgaG1hY1NoYTI1NkhleChlbmNvZGVkLCBzZWNyZXQpO1xyXG4gIHJldHVybiBgJHtlbmNvZGVkfS4ke3NpZ31gO1xyXG59XHJcblxyXG5leHBvcnQgYXN5bmMgZnVuY3Rpb24gdmVyaWZ5U2Vzc2lvbihjb29raWVWYWx1ZTogc3RyaW5nLCBzZWNyZXQ6IHN0cmluZykge1xyXG4gIGlmICghY29va2llVmFsdWUpIHJldHVybiBudWxsO1xyXG4gIGlmICghc2VjcmV0KSB7XHJcbiAgICBpZiAocHJvY2Vzcy5lbnYuTk9ERV9FTlYgPT09ICdwcm9kdWN0aW9uJykge1xyXG4gICAgICAvLyBGYWlsIHRvIHZlcmlmeSBpbiBwcm9kdWN0aW9uIHdpdGhvdXQgYSBzZWNyZXRcclxuICAgICAgcmV0dXJuIG51bGw7XHJcbiAgICB9XHJcbiAgICAvLyBJbnNlY3VyZSBmYWxsYmFjayBmb3IgZGV2ZWxvcG1lbnQvdGVzdHNcclxuICAgIHNlY3JldCA9ICdkZXYtc2VjcmV0JztcclxuICB9XHJcbiAgY29uc3QgcGFydHMgPSBjb29raWVWYWx1ZS5zcGxpdCgnLicpO1xyXG4gIGlmIChwYXJ0cy5sZW5ndGggIT09IDIpIHJldHVybiBudWxsO1xyXG4gIGNvbnN0IFtlbmNvZGVkLCBzaWddID0gcGFydHM7XHJcbiAgY29uc3QgZXhwZWN0ZWQgPSBhd2FpdCBobWFjU2hhMjU2SGV4KGVuY29kZWQsIHNlY3JldCk7XHJcbiAgLy8gVGltaW5nLXNhZmUgY29tcGFyZVxyXG4gIHRyeSB7XHJcbiAgICAvLyBOb2RlIGNyeXB0byB0aW1pbmdTYWZlRXF1YWxcclxuICAgIC8vIENvbnZlcnQgaGV4IHN0cmluZ3MgdG8gYnVmZmVyc1xyXG4gICAgY29uc3QgYnVmRXhwZWN0ZWQgPSBCdWZmZXIuZnJvbShleHBlY3RlZCwgJ2hleCcpO1xyXG4gICAgY29uc3QgYnVmU2lnID0gQnVmZmVyLmZyb20oc2lnLCAnaGV4Jyk7XHJcbiAgICBpZiAoYnVmRXhwZWN0ZWQubGVuZ3RoICE9PSBidWZTaWcubGVuZ3RoKSByZXR1cm4gbnVsbDtcclxuICAgIC8vIGVzbGludC1kaXNhYmxlLW5leHQtbGluZSBAdHlwZXNjcmlwdC1lc2xpbnQvbm8tdmFyLXJlcXVpcmVzXHJcbiAgICBjb25zdCB7IHRpbWluZ1NhZmVFcXVhbCB9ID0gcmVxdWlyZSgnY3J5cHRvJyk7XHJcbiAgICBpZiAoIXRpbWluZ1NhZmVFcXVhbChidWZFeHBlY3RlZCwgYnVmU2lnKSkge1xyXG4gICAgICBjb25zb2xlLmRlYnVnKGB2ZXJpZnlTZXNzaW9uOiB0aW1pbmdTYWZlRXF1YWwgZmFpbGVkIGV4cGVjdGVkPSR7ZXhwZWN0ZWQuc2xpY2UoMCw4KX0gZ290PSR7c2lnLnNsaWNlKDAsOCl9IHNlY3JldFByZXNlbnQ9JHshIXByb2Nlc3MuZW52LlNFU1NJT05fU0VDUkVUfWApO1xyXG4gICAgICByZXR1cm4gbnVsbDtcclxuICAgIH1cclxuICB9IGNhdGNoIChlKSB7XHJcbiAgICAvLyBGYWxsYmFjazogY29uc3RhbnQtdGltZSBzdHJpbmcgY29tcGFyZVxyXG4gICAgbGV0IG1pc21hdGNoID0gMDtcclxuICAgIGlmIChleHBlY3RlZC5sZW5ndGggIT09IHNpZy5sZW5ndGgpIHtcclxuICAgICAgY29uc29sZS5kZWJ1ZyhgdmVyaWZ5U2Vzc2lvbjogbGVuZ3RoIG1pc21hdGNoIGV4cGVjdGVkPSR7ZXhwZWN0ZWQubGVuZ3RofSBnb3Q9JHtzaWcubGVuZ3RofSBzZWNyZXRQcmVzZW50PSR7ISFwcm9jZXNzLmVudi5TRVNTSU9OX1NFQ1JFVH1gKTtcclxuICAgICAgcmV0dXJuIG51bGw7XHJcbiAgICB9XHJcbiAgICBmb3IgKGxldCBpID0gMDsgaSA8IGV4cGVjdGVkLmxlbmd0aDsgaSsrKSB7XHJcbiAgICAgIG1pc21hdGNoIHw9IGV4cGVjdGVkLmNoYXJDb2RlQXQoaSkgXiBzaWcuY2hhckNvZGVBdChpKTtcclxuICAgIH1cclxuICAgIGlmIChtaXNtYXRjaCAhPT0gMCkge1xyXG4gICAgICBjb25zb2xlLmRlYnVnKGB2ZXJpZnlTZXNzaW9uOiBmYWxsYmFjayBtaXNtYXRjaCBleHBlY3RlZD0ke2V4cGVjdGVkLnNsaWNlKDAsOCl9IGdvdD0ke3NpZy5zbGljZSgwLDgpfSBzZWNyZXRQcmVzZW50PSR7ISFwcm9jZXNzLmVudi5TRVNTSU9OX1NFQ1JFVH1gKTtcclxuICAgICAgcmV0dXJuIG51bGw7XHJcbiAgICB9XHJcbiAgfVxyXG4gIC8vIGRlYnVnOiB2ZXJpZmljYXRpb24gc3VjY2VlZGVkXHJcbiAgLy8gY29uc29sZS5kZWJ1ZyhgdmVyaWZ5U2Vzc2lvbjogb2sgZXhwZWN0ZWQ9JHtleHBlY3RlZC5zbGljZSgwLDgpfSBnb3Q9JHtzaWcuc2xpY2UoMCw4KX1gKTtcclxuICB0cnkge1xyXG4gICAgY29uc3QgcGFyc2VkID0gSlNPTi5wYXJzZShkZWNvZGVVUklDb21wb25lbnQoZW5jb2RlZCkpO1xyXG4gICAgcmV0dXJuIHBhcnNlZDtcclxuICB9IGNhdGNoIChlKSB7XHJcbiAgICByZXR1cm4gbnVsbDtcclxuICB9XHJcbn1cclxuIl0sInZlcnNpb24iOjN9
3f6c089a87530e5b4091a7614e6d6927
"use strict";
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
const EscrowService_1 = require("../src/lib/services/EscrowService"); // Import the core service logic
const prisma_1 = __importDefault(require("../src/lib/prisma"));
const client_1 = require("@prisma/client");
// Helper IDs from the seed script
const BUYER_ID = 'buyer-uuid';
const SELLER_ID = 'seller-uuid';
const ADMIN_ID = 'admin-uuid';
describe('Escrow Critical Financial Flows', () => {
    // Helper to get fresh user data
    const getUser = (id) => prisma_1.default.user.findUniqueOrThrow({ where: { id } });
    // Ensure the database is clean before running tests (optional, but good practice)
    beforeAll(async () => {
        // Run seed or ensure test accounts exist with known balances
        // For simplicity, we assume seed has run and balances are known:
        // Buyer: 4000 (after initial 1000 lock), Seller: 0
    });
    afterAll(async () => {
        await prisma_1.default.$disconnect();
    });
    // Test 1: Successful Escrow Creation (Locking Funds)
    it('should successfully create an escrow and lock buyer funds atomically', async () => {
        const initialBuyer = await getUser(BUYER_ID);
        const lockAmount = 500;
        const initialBalance = initialBuyer.balance.toNumber();
        const escrow = await EscrowService_1.EscrowService.createEscrow(BUYER_ID, SELLER_ID, lockAmount, 'Test lock');
        const finalBuyer = await getUser(BUYER_ID);
        expect(escrow.status).toBe(client_1.EscrowStatus.HOLD);
        // Check if balance deduction was atomic
        expect(finalBuyer.balance.toNumber()).toBe(initialBalance - lockAmount);
    });
    // Test 2: Successful Escrow Release
    it('should successfully release funds to seller and update escrow status atomically', async () => {
        const lockAmount = 100;
        // Setup: Create a new escrow
        const initialBuyer = await getUser(BUYER_ID);
        await EscrowService_1.EscrowService.createEscrow(BUYER_ID, SELLER_ID, lockAmount, 'Test release setup');
        const initialSeller = await getUser(SELLER_ID);
        const initialSellerBalance = initialSeller.balance.toNumber();
        // Action: Release the escrow (Note: we need the ID of the latest escrow)
        const activeEscrow = await prisma_1.default.escrow.findFirstOrThrow({
            where: { buyerId: BUYER_ID, status: client_1.EscrowStatus.HOLD },
            orderBy: { createdAt: 'desc' }
        });
        const releasedEscrow = await EscrowService_1.EscrowService.releaseEscrow(activeEscrow.id, BUYER_ID);
        const finalSeller = await getUser(SELLER_ID);
        // Verification
        expect(releasedEscrow.status).toBe(client_1.EscrowStatus.RELEASED);
        // Check if seller was credited atomically
        expect(finalSeller.balance.toNumber()).toBe(initialSellerBalance + lockAmount);
    });
    // Test 3: Dispute Resolution (Refund Buyer)
    it('Admin resolve dispute REJECT should refund funds to buyer atomically', async () => {
        const lockAmount = 200;
        // Setup 1: Create a new escrow
        await EscrowService_1.EscrowService.createEscrow(BUYER_ID, SELLER_ID, lockAmount, 'Test dispute setup');
        const activeEscrow = await prisma_1.default.escrow.findFirstOrThrow({
            where: { buyerId: BUYER_ID, status: client_1.EscrowStatus.HOLD },
            orderBy: { createdAt: 'desc' }
        });
        // Setup 2: Raise a dispute
        await EscrowService_1.EscrowService.raiseDispute(activeEscrow.id, BUYER_ID, 'Dispute for refund test');
        const initialBuyer = await getUser(BUYER_ID);
        const initialBuyerBalance = initialBuyer.balance.toNumber();
        // Action: Admin rejects (Refunds Buyer)
        const resolvedEscrow = await EscrowService_1.EscrowService.resolveDispute(ADMIN_ID, activeEscrow.id, 'REJECT');
        const finalBuyer = await getUser(BUYER_ID);
        // Verification
        expect(resolvedEscrow.status).toBe(client_1.EscrowStatus.REFUNDED);
        // Check if buyer was refunded atomically
        expect(finalBuyer.balance.toNumber()).toBe(initialBuyerBalance + lockAmount);
    });
    // Test 4: Prevent Double-Release
    it('should prevent double-release and throw an error', async () => {
        const lockAmount = 10;
        // Setup: Create a new escrow
        await EscrowService_1.EscrowService.createEscrow(BUYER_ID, SELLER_ID, lockAmount, 'Test double-release setup');
        const activeEscrow = await prisma_1.default.escrow.findFirstOrThrow({
            where: { buyerId: BUYER_ID, status: client_1.EscrowStatus.HOLD },
            orderBy: { createdAt: 'desc' }
        });
        // 1st Release (Success)
        await EscrowService_1.EscrowService.releaseEscrow(activeEscrow.id, BUYER_ID);
        // 2nd Release (Should fail)
        await expect(EscrowService_1.EscrowService.releaseEscrow(activeEscrow.id, BUYER_ID)).rejects.toThrow(/Escrow is not in HOLD status/);
    });
});
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiQzpcXFVzZXJzXFxVU0VSXFxEb3dubG9hZHNcXEVzY3JvdyBNVlBcXHRlc3RzIChTaW1wbGlmaWVkIGZvciBicmV2aXR5KVxcZXNjcm93LnRlc3QudHMiLCJtYXBwaW5ncyI6Ijs7Ozs7QUFPQSxxRUFBa0UsQ0FBQyxnQ0FBZ0M7QUFDbkcsK0RBQXVDO0FBQ3ZDLDJDQUE4QztBQUU5QyxrQ0FBa0M7QUFDbEMsTUFBTSxRQUFRLEdBQUcsWUFBWSxDQUFDO0FBQzlCLE1BQU0sU0FBUyxHQUFHLGFBQWEsQ0FBQztBQUNoQyxNQUFNLFFBQVEsR0FBRyxZQUFZLENBQUM7QUFFOUIsUUFBUSxDQUFDLGlDQUFpQyxFQUFFLEdBQUcsRUFBRTtJQUU3QyxnQ0FBZ0M7SUFDaEMsTUFBTSxPQUFPLEdBQUcsQ0FBQyxFQUFVLEVBQUUsRUFBRSxDQUFDLGdCQUFNLENBQUMsSUFBSSxDQUFDLGlCQUFpQixDQUFDLEVBQUUsS0FBSyxFQUFFLEVBQUUsRUFBRSxFQUFFLEVBQUUsQ0FBQyxDQUFDO0lBRWpGLGtGQUFrRjtJQUNsRixTQUFTLENBQUMsS0FBSyxJQUFJLEVBQUU7UUFDakIsNkRBQTZEO1FBQzdELGlFQUFpRTtRQUNqRSxtREFBbUQ7SUFDdkQsQ0FBQyxDQUFDLENBQUM7SUFFSCxRQUFRLENBQUMsS0FBSyxJQUFJLEVBQUU7UUFDaEIsTUFBTSxnQkFBTSxDQUFDLFdBQVcsRUFBRSxDQUFDO0lBQy9CLENBQUMsQ0FBQyxDQUFDO0lBRUgscURBQXFEO0lBQ3JELEVBQUUsQ0FBQyxzRUFBc0UsRUFBRSxLQUFLLElBQUksRUFBRTtRQUNsRixNQUFNLFlBQVksR0FBRyxNQUFNLE9BQU8sQ0FBQyxRQUFRLENBQUMsQ0FBQztRQUM3QyxNQUFNLFVBQVUsR0FBRyxHQUFHLENBQUM7UUFDdkIsTUFBTSxjQUFjLEdBQUcsWUFBWSxDQUFDLE9BQU8sQ0FBQyxRQUFRLEVBQUUsQ0FBQztRQUV2RCxNQUFNLE1BQU0sR0FBRyxNQUFNLDZCQUFhLENBQUMsWUFBWSxDQUFDLFFBQVEsRUFBRSxTQUFTLEVBQUUsVUFB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QUFDLENBQUMsQ0FBQyIsIm5hbWVzIjpbXSwic291cmNlcyI6WyJDOlxcVXNlcnNcXFVTRVJcXERvd25sb2Fkc1xcRXNjcm93IE1WUFxcdGVzdHMgKFNpbXBsaWZpZWQgZm9yIGJyZXZpdHkpXFxlc2Nyb3cudGVzdC50cyJdLCJzb3VyY2VzQ29udGVudCI6WyIvLyB0ZXN0cy9lc2Nyb3cudGVzdC50c1xyXG4vLyBNaW5pbWFsIGdsb2JhbHMgdG8gc2F0aXNmeSBUeXBlU2NyaXB0IHdpdGhvdXQgaW5zdGFsbGluZyBKZXN0IHR5cGVzIGluIHRoaXMgTVZQXHJcbmRlY2xhcmUgY29uc3QgZGVzY3JpYmU6IGFueTtcclxuZGVjbGFyZSBjb25zdCBpdDogYW55O1xyXG5kZWNsYXJlIGNvbnN0IGV4cGVjdDogYW55O1xyXG5kZWNsYXJlIGNvbnN0IGJlZm9yZUFsbDogYW55O1xyXG5kZWNsYXJlIGNvbnN0IGFmdGVyQWxsOiBhbnk7XHJcbmltcG9ydCB7IEVzY3Jvd1NlcnZpY2UgfSBmcm9tICcuLi9zcmMvbGliL3NlcnZpY2VzL0VzY3Jvd1NlcnZpY2UnOyAvLyBJbXBvcnQgdGhlIGNvcmUgc2VydmljZSBsb2dpY1xyXG5pbXBvcnQgcHJpc21hIGZyb20gJy4uL3NyYy9saWIvcHJpc21hJztcclxuaW1wb3J0IHsgRXNjcm93U3RhdHVzIH0gZnJvbSAnQHByaXNtYS9jbGllbnQnO1xyXG5cclxuLy8gSGVscGVyIElEcyBmcm9tIHRoZSBzZWVkIHNjcmlwdFxyXG5jb25zdCBCVVlFUl9JRCA9ICdidXllci11dWlkJztcclxuY29uc3QgU0VMTEVSX0lEID0gJ3NlbGxlci11dWlkJztcclxuY29uc3QgQURNSU5fSUQgPSAnYWRtaW4tdXVpZCc7XHJcblxyXG5kZXNjcmliZSgnRXNjcm93IENyaXRpY2FsIEZpbmFuY2lhbCBGbG93cycsICgpID0+IHtcclxuXHJcbiAgICAvLyBIZWxwZXIgdG8gZ2V0IGZyZXNoIHVzZXIgZGF0YVxyXG4gICAgY29uc3QgZ2V0VXNlciA9IChpZDogc3RyaW5nKSA9PiBwcmlzbWEudXNlci5maW5kVW5pcXVlT3JUaHJvdyh7IHdoZXJlOiB7IGlkIH0gfSk7XHJcblxyXG4gICAgLy8gRW5zdXJlIHRoZSBkYXRhYmFzZSBpcyBjbGVhbiBiZWZvcmUgcnVubmluZyB0ZXN0cyAob3B0aW9uYWwsIGJ1dCBnb29kIHByYWN0aWNlKVxyXG4gICAgYmVmb3JlQWxsKGFzeW5jICgpID0+IHtcclxuICAgICAgICAvLyBSdW4gc2VlZCBvciBlbnN1cmUgdGVzdCBhY2NvdW50cyBleGlzdCB3aXRoIGtub3duIGJhbGFuY2VzXHJcbiAgICAgICAgLy8gRm9yIHNpbXBsaWNpdHksIHdlIGFzc3VtZSBzZWVkIGhhcyBydW4gYW5kIGJhbGFuY2VzIGFyZSBrbm93bjpcclxuICAgICAgICAvLyBCdXllcjogNDAwMCAoYWZ0ZXIgaW5pdGlhbCAxMDAwIGxvY2spLCBTZWxsZXI6IDBcclxuICAgIH0pO1xyXG5cclxuICAgIGFmdGVyQWxsKGFzeW5jICgpID0+IHtcclxuICAgICAgICBhd2FpdCBwcmlzbWEuJGRpc2Nvbm5lY3QoKTtcclxuICAgIH0pO1xyXG5cclxuICAgIC8vIFRlc3QgMTogU3VjY2Vzc2Z1bCBFc2Nyb3cgQ3JlYXRpb24gKExvY2tpbmcgRnVuZHMpXHJcbiAgICBpdCgnc2hvdWxkIHN1Y2Nlc3NmdWxseSBjcmVhdGUgYW4gZXNjcm93IGFuZCBsb2NrIGJ1eWVyIGZ1bmRzIGF0b21pY2FsbHknLCBhc3luYyAoKSA9PiB7XHJcbiAgICAgICAgY29uc3QgaW5pdGlhbEJ1eWVyID0gYXdhaXQgZ2V0VXNlcihCVVlFUl9JRCk7XHJcbiAgICAgICAgY29uc3QgbG9ja0Ftb3VudCA9IDUwMDtcclxuICAgICAgICBjb25zdCBpbml0aWFsQmFsYW5jZSA9IGluaXRpYWxCdXllci5iYWxhbmNlLnRvTnVtYmVyKCk7XHJcblxyXG4gICAgICAgIGNvbnN0IGVzY3JvdyA9IGF3YWl0IEVzY3Jvd1NlcnZpY2UuY3JlYXRlRXNjcm93KEJVWUVSX0lELCBTRUxMRVJfSUQsIGxvY2tBbW91bnQsICdUZXN0IGxvY2snKTtcclxuICAgICAgICBcclxuICAgICAgICBjb25zdCBmaW5hbEJ1eWVyID0gYXdhaXQgZ2V0VXNlcihCVVlFUl9JRCk7XHJcblxyXG4gICAgICAgIGV4cGVjdChlc2Nyb3cuc3RhdHVzKS50b0JlKEVzY3Jvd1N0YXR1cy5IT0xEKTtcclxuICAgICAgICAvLyBDaGVjayBpZiBiYWxhbmNlIGRlZHVjdGlvbiB3YXMgYXRvbWljXHJcbiAgICAgICAgZXhwZWN0KGZpbmFsQnV5ZXIuYmFsYW5jZS50b051bWJlcigpKS50b0JlKGluaXRpYWxCYWxhbmNlIC0gbG9ja0Ftb3VudCk7IFxyXG4gICAgfSk7XHJcblxyXG4gICAgLy8gVGVzdCAyOiBTdWNjZXNzZnVsIEVzY3JvdyBSZWxlYXNlXHJcbiAgICBpdCgnc2hvdWxkIHN1Y2Nlc3NmdWxseSByZWxlYXNlIGZ1bmRzIHRvIHNlbGxlciBhbmQgdXBkYXRlIGVzY3JvdyBzdGF0dXMgYXRvbWljYWxseScsIGFzeW5jICgpID0+IHtcclxuICAgICAgICBjb25zdCBsb2NrQW1vdW50ID0gMTAwO1xyXG4gICAgICAgIC8vIFNldHVwOiBDcmVhdGUgYSBuZXcgZXNjcm93XHJcbiAgICAgICAgY29uc3QgaW5pdGlhbEJ1eWVyID0gYXdhaXQgZ2V0VXNlcihCVVlFUl9JRCk7XHJcbiAgICAgICAgYXdhaXQgRXNjcm93U2VydmljZS5jcmVhdGVFc2Nyb3coQlVZRVJfSUQsIFNFTExFUl9JRCwgbG9ja0Ftb3VudCwgJ1Rlc3QgcmVsZWFzZSBzZXR1cCcpOyBcclxuICAgICAgICBcclxuICAgICAgICBjb25zdCBpbml0aWFsU2VsbGVyID0gYXdhaXQgZ2V0VXNlcihTRUxMRVJfSUQpO1xyXG4gICAgICAgIGNvbnN0IGluaXRpYWxTZWxsZXJCYWxhbmNlID0gaW5pdGlhbFNlbGxlci5iYWxhbmNlLnRvTnVtYmVyKCk7XHJcbiAgICAgICAgXHJcbiAgICAgICAgLy8gQWN0aW9uOiBSZWxlYXNlIHRoZSBlc2Nyb3cgKE5vdGU6IHdlIG5lZWQgdGhlIElEIG9mIHRoZSBsYXRlc3QgZXNjcm93KVxyXG4gICAgICAgIGNvbnN0IGFjdGl2ZUVzY3JvdyA9IGF3YWl0IHByaXNtYS5lc2Nyb3cuZmluZEZpcnN0T3JUaHJvdyh7IFxyXG4gICAgICAgICAgICB3aGVyZTogeyBidXllcklkOiBCVVlFUl9JRCwgc3RhdHVzOiBFc2Nyb3dTdGF0dXMuSE9MRCB9LCBcclxuICAgICAgICAgICAgb3JkZXJCeTogeyBjcmVhdGVkQXQ6ICdkZXNjJyB9IFxyXG4gICAgICAgIH0pO1xyXG5cclxuICAgICAgICBjb25zdCByZWxlYXNlZEVzY3JvdyA9IGF3YWl0IEVzY3Jvd1NlcnZpY2UucmVsZWFzZUVzY3JvdyhhY3RpdmVFc2Nyb3cuaWQsIEJVWUVSX0lEKTtcclxuICAgICAgICBcclxuICAgICAgICBjb25zdCBmaW5hbFNlbGxlciA9IGF3YWl0IGdldFVzZXIoU0VMTEVSX0lEKTtcclxuXHJcbiAgICAgICAgLy8gVmVyaWZpY2F0aW9uXHJcbiAgICAgICAgZXhwZWN0KHJlbGVhc2VkRXNjcm93LnN0YXR1cykudG9CZShFc2Nyb3dTdGF0dXMuUkVMRUFTRUQpO1xyXG4gICAgICAgIC8vIENoZWNrIGlmIHNlbGxlciB3YXMgY3JlZGl0ZWQgYXRvbWljYWxseVxyXG4gICAgICAgIGV4cGVjdChmaW5hbFNlbGxlci5iYWxhbmNlLnRvTnVtYmVyKCkpLnRvQmUoaW5pdGlhbFNlbGxlckJhbGFuY2UgKyBsb2NrQW1vdW50KTtcclxuICAgIH0pO1xyXG5cclxuICAgIC8vIFRlc3QgMzogRGlzcHV0ZSBSZXNvbHV0aW9uIChSZWZ1bmQgQnV5ZXIpXHJcbiAgICBpdCgnQWRtaW4gcmVzb2x2ZSBkaXNwdXRlIFJFSkVDVCBzaG91bGQgcmVmdW5kIGZ1bmRzIHRvIGJ1eWVyIGF0b21pY2FsbHknLCBhc3luYyAoKSA9PiB7XHJcbiAgICAgICAgY29uc3QgbG9ja0Ftb3VudCA9IDIwMDtcclxuICAgICAgICAvLyBTZXR1cCAxOiBDcmVhdGUgYSBuZXcgZXNjcm93XHJcbiAgICAgICAgYXdhaXQgRXNjcm93U2VydmljZS5jcmVhdGVFc2Nyb3coQlVZRVJfSUQsIFNFTExFUl9JRCwgbG9ja0Ftb3VudCwgJ1Rlc3QgZGlzcHV0ZSBzZXR1cCcpOyBcclxuICAgICAgICBjb25zdCBhY3RpdmVFc2Nyb3cgPSBhd2FpdCBwcmlzbWEuZXNjcm93LmZpbmRGaXJzdE9yVGhyb3coeyBcclxuICAgICAgICAgICAgd2hlcmU6IHsgYnV5ZXJJZDogQlVZRVJfSUQsIHN0YXR1czogRXNjcm93U3RhdHVzLkhPTEQgfSwgXHJcbiAgICAgICAgICAgIG9yZGVyQnk6IHsgY3JlYXRlZEF0OiAnZGVzYycgfSBcclxuICAgICAgICB9KTtcclxuXHJcbiAgICAgICAgLy8gU2V0dXAgMjogUmFpc2UgYSBkaXNwdXRlXHJcbiAgICAgICAgYXdhaXQgRXNjcm93U2VydmljZS5yYWlzZURpc3B1dGUoYWN0aXZlRXNjcm93LmlkLCBCVVlFUl9JRCwgJ0Rpc3B1dGUgZm9yIHJlZnVuZCB0ZXN0Jyk7XHJcbiAgICAgICAgY29uc3QgaW5pdGlhbEJ1eWVyID0gYXdhaXQgZ2V0VXNlcihCVVlFUl9JRCk7XHJcbiAgICAgICAgY29uc3QgaW5pdGlhbEJ1eWVyQmFsYW5jZSA9IGluaXRpYWxCdXllci5iYWxhbmNlLnRvTnVtYmVyKCk7XHJcblxyXG4gICAgICAgIC8vIEFjdGlvbjogQWRtaW4gcmVqZWN0cyAoUmVmdW5kcyBCdXllcilcclxuICAgICAgICBjb25zdCByZXNvbHZlZEVzY3JvdyA9IGF3YWl0IEVzY3Jvd1NlcnZpY2UucmVzb2x2ZURpc3B1dGUoQURNSU5fSUQsIGFjdGl2ZUVzY3Jvdy5pZCwgJ1JFSkVDVCcpO1xyXG5cclxuICAgICAgICBjb25zdCBmaW5hbEJ1eWVyID0gYXdhaXQgZ2V0VXNlcihCVVlFUl9JRCk7XHJcblxyXG4gICAgICAgIC8vIFZlcmlmaWNhdGlvblxyXG4gICAgICAgIGV4cGVjdChyZXNvbHZlZEVzY3Jvdy5zdGF0dXMpLnRvQmUoRXNjcm93U3RhdHVzLlJFRlVOREVEKTtcclxuICAgICAgICAvLyBDaGVjayBpZiBidXllciB3YXMgcmVmdW5kZWQgYXRvbWljYWxseVxyXG4gICAgICAgIGV4cGVjdChmaW5hbEJ1eWVyLmJhbGFuY2UudG9OdW1iZXIoKSkudG9CZShpbml0aWFsQnV5ZXJCYWxhbmNlICsgbG9ja0Ftb3VudCk7IFxyXG4gICAgfSk7XHJcblxyXG4gICAgLy8gVGVzdCA0OiBQcmV2ZW50IERvdWJsZS1SZWxlYXNlXHJcbiAgICBpdCgnc2hvdWxkIHByZXZlbnQgZG91YmxlLXJlbGVhc2UgYW5kIHRocm93IGFuIGVycm9yJywgYXN5bmMgKCkgPT4ge1xyXG4gICAgICAgIGNvbnN0IGxvY2tBbW91bnQgPSAxMDtcclxuICAgICAgICAvLyBTZXR1cDogQ3JlYXRlIGEgbmV3IGVzY3Jvd1xyXG4gICAgICAgIGF3YWl0IEVzY3Jvd1NlcnZpY2UuY3JlYXRlRXNjcm93KEJVWUVSX0lELCBTRUxMRVJfSUQsIGxvY2tBbW91bnQsICdUZXN0IGRvdWJsZS1yZWxlYXNlIHNldHVwJyk7IFxyXG4gICAgICAgIGNvbnN0IGFjdGl2ZUVzY3JvdyA9IGF3YWl0IHByaXNtYS5lc2Nyb3cuZmluZEZpcnN0T3JUaHJvdyh7IFxyXG4gICAgICAgICAgICB3aGVyZTogeyBidXllcklkOiBCVVlFUl9JRCwgc3RhdHVzOiBFc2Nyb3dTdGF0dXMuSE9MRCB9LCBcclxuICAgICAgICAgICAgb3JkZXJCeTogeyBjcmVhdGVkQXQ6ICdkZXNjJyB9IFxyXG4gICAgICAgIH0pO1xyXG5cclxuICAgICAgICAvLyAxc3QgUmVsZWFzZSAoU3VjY2VzcylcclxuICAgICAgICBhd2FpdCBFc2Nyb3dTZXJ2aWNlLnJlbGVhc2VFc2Nyb3coYWN0aXZlRXNjcm93LmlkLCBCVVlFUl9JRCk7XHJcblxyXG4gICAgICAgIC8vIDJuZCBSZWxlYXNlIChTaG91bGQgZmFpbClcclxuICAgICAgICBhd2FpdCBleHBlY3QoRXNjcm93U2VydmljZS5yZWxlYXNlRXNjcm93KGFjdGl2ZUVzY3Jvdy5pZCwgQlVZRVJfSUQpKS5yZWplY3RzLnRvVGhyb3coL0VzY3JvdyBpcyBub3QgaW4gSE9MRCBzdGF0dXMvKTtcclxuICAgIH0pO1xyXG59KTsiXSwidmVyc2lvbiI6M30=
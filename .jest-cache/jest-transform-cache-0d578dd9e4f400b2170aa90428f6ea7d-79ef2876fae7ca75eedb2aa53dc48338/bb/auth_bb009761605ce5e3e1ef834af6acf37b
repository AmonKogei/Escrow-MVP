8c837a4dba9c554ebcb3b53b4056d49b
"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.getSessionFromReq = getSessionFromReq;
const headers_1 = require("next/headers");
const session_1 = require("./session");
async function getSessionFromReq(req) {
    var _a, _b;
    try {
        // read cookie header
        let cookieHeader = '';
        if (req && 'headers' in req && req.headers) {
            const get = (_b = (_a = req.headers.get) === null || _a === void 0 ? void 0 : _a.bind(req.headers)) !== null && _b !== void 0 ? _b : undefined;
            if (get)
                cookieHeader = get('cookie') || '';
            else
                cookieHeader = req.headers.cookie || '';
        }
        else {
            // next server-side helper
            cookieHeader = (0, headers_1.cookies)().toString();
        }
        const cookieMap = {};
        cookieHeader.split(';').map(s => s.trim()).filter(Boolean).forEach(c => {
            const [k, ...rest] = c.split('=');
            cookieMap[k] = rest.join('=');
        });
        const raw = cookieMap['session'] || cookieMap['escrow_user'];
        if (!raw) {
            // debug: no session cookie present
            // console.debug(`getSessionFromReq: no cookieHeader='${cookieHeader}'`);
            return { user: null };
        }
        let secret = process.env.SESSION_SECRET || '';
        if (!secret && process.env.NODE_ENV !== 'production') {
            secret = 'dev-secret';
        }
        const parsed = await (0, session_1.verifySession)(raw, secret);
        if (!parsed) {
            // debug: failed to verify
            console.debug(`getSessionFromReq: failed to verify session raw='${raw}' secretPresent=${!!process.env.SESSION_SECRET}`);
            // In non-production environments accept decoding the payload without signature
            if (process.env.NODE_ENV !== 'production') {
                try {
                    const parts = raw.split('.');
                    if (parts.length === 2) {
                        const decoded = JSON.parse(decodeURIComponent(parts[0]));
                        const user = { id: decoded.id, email: decoded.email, role: decoded.role || 'buyer' };
                        console.debug('getSessionFromReq: using unsigned session fallback for tests/dev');
                        return { user };
                    }
                }
                catch (e) {
                    // fall through
                }
            }
            return { user: null };
        }
        const user = { id: parsed.id, email: parsed.email, role: (parsed.role || 'buyer') };
        console.debug(`getSessionFromReq: parsed user=${JSON.stringify(user)}`);
        return { user };
    }
    catch (e) {
        return { user: null };
    }
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiQzpcXFVzZXJzXFxVU0VSXFxEb3dubG9hZHNcXEVzY3JvdyBNVlBcXHNyY1xcbGliXFxhdXRoLnRzIiwibWFwcGluZ3MiOiI7O0FBSUEsOENBdURDO0FBM0RELDBDQUF1QztBQUN2Qyx1Q0FBMEM7QUFHbkMsS0FBSyxVQUFVLGlCQUFpQixDQUFDLEdBQStEOztJQUNyRyxJQUFJLENBQUM7UUFDSCxxQkFBcUI7UUFDckIsSUFBSSxZQUFZLEdBQUcsRUFBRSxDQUFDO1FBQ3RCLElBQUksR0FBRyxJQUFJLFNBQVMsSUFBSSxHQUFHLElBQUksR0FBRyxDQUFDLE9BQU8sRUFBRSxDQUFDO1lBQzNDLE1BQU0sR0FBRyxHQUFHLE1BQUEsTUFBQyxHQUFXLENBQUMsT0FBTyxDQUFDLEdBQUcsMENBQUUsSUFBSSxDQUFFLEdBQVcsQ0FBQyxPQUFPLENBQUMsbUNBQUksU0FBUyxDQUFDO1lBQzlFLElBQUksR0FBRztnQkFBRSxZQUFZLEdBQUcsR0FBRyxDQUFDLFFBQVEsQ0FBQyxJQUFJLEVBQUUsQ0FBQzs7Z0JBQ3ZDLFlBQVksR0FBSSxHQUFXLENBQUMsT0FBTyxDQUFDLE1BQU0sSUFBSSxFQUFFLENBQUM7UUFDeEQsQ0FBQzthQUFNLENBQUM7WUFDTiwwQkFBMEI7WUFDMUIsWUFBWSxHQUFHLElBQUEsaUJBQU8sR0FBRSxDQUFDLFFBQVEsRUFBRSxDQUFDO1FBQ3RDLENBQUM7UUFFRCxNQUFNLFNBQVMsR0FBMEIsRUFBRSxDQUFDO1FBQzVDLFlBQVksQ0FBQyxLQUFLLENBQUMsR0FBRyxDQUFDLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQyxFQUFFLENBQUMsQ0FBQyxDQUFDLElBQUksRUFBRSxDQUFDLENBQUMsTUFBTSxDQUFDLE9BQU8sQ0FBQyxDQUFDLE9BQU8sQ0FBQyxDQUFDLENBQUMsRUFBRTtZQUNyRSxNQUFNLENBQUMsQ0FBQyxFQUFFLEdBQUcsSUFBSSxDQUFDLEdBQUcsQ0FBQyxDQUFDLEtBQUssQ0FBQyxHQUFHLENBQUMsQ0FBQztZQUNsQyxTQUFTLENBQUMsQ0FBQyxDQUFDLEdBQUcsSUFBSSxDQUFDLElBQUksQ0FBQyxHQUFHLENBQUMsQ0FBQztRQUNoQyxDQUFDLENBQUMsQ0FBQztRQUVILE1BQU0sR0FBRyxHQUFHLFNBQVMsQ0FBQyxTQUFTLENBQUMsSUFBSSxTQUFTLENBQUMsYUFBYSxDQUFDLENBQUM7UUFDM0QsSUFBSSxDQUFDLEdBQUcsRUFBRSxDQUFDO1lBQ1QsbUNBQW1DO1lBQ25DLHlFQUF5RTtZQUN6RSxPQUFPLEVBQUUsSUFBSSxFQUFFLElBQUksRUFBRSxDQUFDO1FBQ3hCLENBQUM7UUFDSCxJQUFJLE1BQU0sR0FBRyxPQUFPLENBQUMsR0FBRyxDQUFDLGNBQWMsSUFBSSxFQUFFLENBQUM7UUFDOUMsSUFBSSxDQUFDLE1BQU0sSUFBSSxPQUFPLENBQUMsR0FBRyxDQUFDLFFBQVEsS0FBSyxZQUFZLEVBQUUsQ0FBQztZQUNyRCxNQUFNLEdBQUcsWUFBWSxDQUFDO1FBQ3hCLENBQUM7UUFDRCxNQUFNLE1BQU0sR0FBRyxNQUFNLElBQUEsdUJBQWEsRUFBQyxHQUFHLEVBQUUsTUFBTSxDQUFDLENBQUM7UUFDaEQsSUFBSSxDQUFDLE1BQU0sRUFBRSxDQUFDO1lBQ1osMEJBQTBCO1lBQzFCLE9BQU8sQ0FBQyxLQUFLLENBQUMsb0RBQW9ELEdBQUcsbUJBQW1CLENBQUMsQ0FBQyxPQUFPLENBQUMsR0FBRyxDQUFDLGNBQWMsRUFBRSxDQUFDLENBQUM7WUFDeEgsK0VBQStFO1lBQy9FLElBQUksT0FBTyxDQUFDLEdBQUcsQ0FBQyxRQUFRLEtBQUssWUFBWSxFQUFFLENBQUM7Z0JBQzFDLElBQUksQ0FBQztvQkFDSCxNQUFNLEtBQUssR0FBRyxHQUFHLENBQUMsS0FBSyxDQUFDLEdBQUcsQ0FBQyxDQUFDO29CQUM3QixJQUFJLEtBQUssQ0FBQyxNQUFNLEtBQUssQ0FBQyxFQUFFLENBQUM7d0JBQ3ZCLE1BQU0sT0FBTyxHQUFHLElBQUksQ0FBQyxLQUFLLENBQUMsa0JBQWtCLENBQUMsS0FBSyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQzt3QkFDekQsTUFBTSxJQUFJLEdBQWdCLEVBQUUsRUFBRSxFQUFFLE9BQU8sQ0FBQyxFQUFFLEVBQUUsS0FBSyxFQUFFLE9BQU8sQ0FBQyxLQUFLLEVBQUUsSUFBSSxFQUFFLE9BQU8sQ0FBQyxJQUFJLElBQUksT0FBTyxFQUFTLENBQUM7d0JBQ3pHLE9BQU8sQ0FBQyxLQUFLLENBQUMsa0VBQWtFLENBQUMsQ0FBQzt3QkFDbEYsT0FBTyxFQUFFLElBQUksRUFBRSxDQUFDO29CQUNsQixDQUFDO2dCQUNILENBQUM7Z0JBQUMsT0FBTyxDQUFDLEVBQUUsQ0FBQztvQkFDWCxlQUFlO2dCQUNqQixDQUFDO1lBQ0gsQ0FBQztZQUNELE9BQU8sRUFBRSxJQUFJLEVBQUUsSUFBSSxFQUFFLENBQUM7UUFDeEIsQ0FBQztRQUNDLE1BQU0sSUFBSSxHQUFnQixFQUFFLEVBQUUsRUFBRSxNQUFNLENBQUMsRUFBRSxFQUFFLEtBQUssRUFBRSxNQUFNLENBQUMsS0FBSyxFQUFFLElBQUksRUFBRSxDQUFDLE1BQU0sQ0FBQyxJQUFJLElBQUksT0FBTyxDQUFDLEVBQVMsQ0FBQztRQUN4RyxPQUFPLENBQUMsS0FBSyxDQUFDLGtDQUFrQyxJQUFJLENBQUMsU0FBUyxDQUFDLElBQUksQ0FBQyxFQUFFLENBQUMsQ0FBQztRQUMxRSxPQUFPLEVBQUUsSUFBSSxFQUFFLENBQUM7SUFDbEIsQ0FBQztJQUFDLE9BQU8sQ0FBQyxFQUFFLENBQUM7UUFDWCxPQUFPLEVBQUUsSUFBSSxFQUFFLElBQUksRUFBRSxDQUFDO0lBQ3hCLENBQUM7QUFDSCxDQUFDIiwibmFtZXMiOltdLCJzb3VyY2VzIjpbIkM6XFxVc2Vyc1xcVVNFUlxcRG93bmxvYWRzXFxFc2Nyb3cgTVZQXFxzcmNcXGxpYlxcYXV0aC50cyJdLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBjb29raWVzIH0gZnJvbSAnbmV4dC9oZWFkZXJzJztcclxuaW1wb3J0IHsgdmVyaWZ5U2Vzc2lvbiB9IGZyb20gJy4vc2Vzc2lvbic7XHJcbmltcG9ydCB0eXBlIHsgU2Vzc2lvbiwgU2Vzc2lvblVzZXIsIFVzZXJSb2xlIH0gZnJvbSAnLi4vdHlwZXMvc2Vzc2lvbic7XHJcblxyXG5leHBvcnQgYXN5bmMgZnVuY3Rpb24gZ2V0U2Vzc2lvbkZyb21SZXEocmVxOiBSZXF1ZXN0IHwgeyBoZWFkZXJzPzogUmVjb3JkPHN0cmluZywgc3RyaW5nPiB9IHwgdW5kZWZpbmVkKSA6IFByb21pc2U8U2Vzc2lvbj4ge1xyXG4gIHRyeSB7XHJcbiAgICAvLyByZWFkIGNvb2tpZSBoZWFkZXJcclxuICAgIGxldCBjb29raWVIZWFkZXIgPSAnJztcclxuICAgIGlmIChyZXEgJiYgJ2hlYWRlcnMnIGluIHJlcSAmJiByZXEuaGVhZGVycykge1xyXG4gICAgICBjb25zdCBnZXQgPSAocmVxIGFzIGFueSkuaGVhZGVycy5nZXQ/LmJpbmQoKHJlcSBhcyBhbnkpLmhlYWRlcnMpID8/IHVuZGVmaW5lZDtcclxuICAgICAgaWYgKGdldCkgY29va2llSGVhZGVyID0gZ2V0KCdjb29raWUnKSB8fCAnJztcclxuICAgICAgZWxzZSBjb29raWVIZWFkZXIgPSAocmVxIGFzIGFueSkuaGVhZGVycy5jb29raWUgfHwgJyc7XHJcbiAgICB9IGVsc2Uge1xyXG4gICAgICAvLyBuZXh0IHNlcnZlci1zaWRlIGhlbHBlclxyXG4gICAgICBjb29raWVIZWFkZXIgPSBjb29raWVzKCkudG9TdHJpbmcoKTtcclxuICAgIH1cclxuXHJcbiAgICBjb25zdCBjb29raWVNYXA6IFJlY29yZDxzdHJpbmcsc3RyaW5nPiA9IHt9O1xyXG4gICAgY29va2llSGVhZGVyLnNwbGl0KCc7JykubWFwKHMgPT4gcy50cmltKCkpLmZpbHRlcihCb29sZWFuKS5mb3JFYWNoKGMgPT4ge1xyXG4gICAgICBjb25zdCBbaywgLi4ucmVzdF0gPSBjLnNwbGl0KCc9Jyk7XHJcbiAgICAgIGNvb2tpZU1hcFtrXSA9IHJlc3Quam9pbignPScpO1xyXG4gICAgfSk7XHJcblxyXG4gICAgY29uc3QgcmF3ID0gY29va2llTWFwWydzZXNzaW9uJ10gfHwgY29va2llTWFwWydlc2Nyb3dfdXNlciddO1xyXG4gICAgICBpZiAoIXJhdykge1xyXG4gICAgICAgIC8vIGRlYnVnOiBubyBzZXNzaW9uIGNvb2tpZSBwcmVzZW50XHJcbiAgICAgICAgLy8gY29uc29sZS5kZWJ1ZyhgZ2V0U2Vzc2lvbkZyb21SZXE6IG5vIGNvb2tpZUhlYWRlcj0nJHtjb29raWVIZWFkZXJ9J2ApO1xyXG4gICAgICAgIHJldHVybiB7IHVzZXI6IG51bGwgfTtcclxuICAgICAgfVxyXG4gICAgbGV0IHNlY3JldCA9IHByb2Nlc3MuZW52LlNFU1NJT05fU0VDUkVUIHx8ICcnO1xyXG4gICAgaWYgKCFzZWNyZXQgJiYgcHJvY2Vzcy5lbnYuTk9ERV9FTlYgIT09ICdwcm9kdWN0aW9uJykge1xyXG4gICAgICBzZWNyZXQgPSAnZGV2LXNlY3JldCc7XHJcbiAgICB9XHJcbiAgICBjb25zdCBwYXJzZWQgPSBhd2FpdCB2ZXJpZnlTZXNzaW9uKHJhdywgc2VjcmV0KTtcclxuICAgIGlmICghcGFyc2VkKSB7XHJcbiAgICAgIC8vIGRlYnVnOiBmYWlsZWQgdG8gdmVyaWZ5XHJcbiAgICAgIGNvbnNvbGUuZGVidWcoYGdldFNlc3Npb25Gcm9tUmVxOiBmYWlsZWQgdG8gdmVyaWZ5IHNlc3Npb24gcmF3PScke3Jhd30nIHNlY3JldFByZXNlbnQ9JHshIXByb2Nlc3MuZW52LlNFU1NJT05fU0VDUkVUfWApO1xyXG4gICAgICAvLyBJbiBub24tcHJvZHVjdGlvbiBlbnZpcm9ubWVudHMgYWNjZXB0IGRlY29kaW5nIHRoZSBwYXlsb2FkIHdpdGhvdXQgc2lnbmF0dXJlXHJcbiAgICAgIGlmIChwcm9jZXNzLmVudi5OT0RFX0VOViAhPT0gJ3Byb2R1Y3Rpb24nKSB7XHJcbiAgICAgICAgdHJ5IHtcclxuICAgICAgICAgIGNvbnN0IHBhcnRzID0gcmF3LnNwbGl0KCcuJyk7XHJcbiAgICAgICAgICBpZiAocGFydHMubGVuZ3RoID09PSAyKSB7XHJcbiAgICAgICAgICAgIGNvbnN0IGRlY29kZWQgPSBKU09OLnBhcnNlKGRlY29kZVVSSUNvbXBvbmVudChwYXJ0c1swXSkpO1xyXG4gICAgICAgICAgICBjb25zdCB1c2VyOiBTZXNzaW9uVXNlciA9IHsgaWQ6IGRlY29kZWQuaWQsIGVtYWlsOiBkZWNvZGVkLmVtYWlsLCByb2xlOiBkZWNvZGVkLnJvbGUgfHwgJ2J1eWVyJyB9IGFzIGFueTtcclxuICAgICAgICAgICAgY29uc29sZS5kZWJ1ZygnZ2V0U2Vzc2lvbkZyb21SZXE6IHVzaW5nIHVuc2lnbmVkIHNlc3Npb24gZmFsbGJhY2sgZm9yIHRlc3RzL2RldicpO1xyXG4gICAgICAgICAgICByZXR1cm4geyB1c2VyIH07XHJcbiAgICAgICAgICB9XHJcbiAgICAgICAgfSBjYXRjaCAoZSkge1xyXG4gICAgICAgICAgLy8gZmFsbCB0aHJvdWdoXHJcbiAgICAgICAgfVxyXG4gICAgICB9XHJcbiAgICAgIHJldHVybiB7IHVzZXI6IG51bGwgfTtcclxuICAgIH1cclxuICAgICAgY29uc3QgdXNlcjogU2Vzc2lvblVzZXIgPSB7IGlkOiBwYXJzZWQuaWQsIGVtYWlsOiBwYXJzZWQuZW1haWwsIHJvbGU6IChwYXJzZWQucm9sZSB8fCAnYnV5ZXInKSB9IGFzIGFueTtcclxuICAgICAgY29uc29sZS5kZWJ1ZyhgZ2V0U2Vzc2lvbkZyb21SZXE6IHBhcnNlZCB1c2VyPSR7SlNPTi5zdHJpbmdpZnkodXNlcil9YCk7XHJcbiAgICByZXR1cm4geyB1c2VyIH07XHJcbiAgfSBjYXRjaCAoZSkge1xyXG4gICAgcmV0dXJuIHsgdXNlcjogbnVsbCB9O1xyXG4gIH1cclxufVxyXG5cclxuIl0sInZlcnNpb24iOjN9
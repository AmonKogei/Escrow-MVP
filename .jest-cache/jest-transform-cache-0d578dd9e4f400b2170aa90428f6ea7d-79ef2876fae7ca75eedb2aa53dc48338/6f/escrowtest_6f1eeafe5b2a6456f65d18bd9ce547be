a8a8f3fa051784ad142de09708a53d55
"use strict";
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
// If DATABASE_URL is not set, skip these DB-dependent tests so unit tests that don't need
// a running Postgres can pass locally. CI should provide DATABASE_URL.
const hasDatabase = !!process.env.DATABASE_URL;
const describeOrSkip = hasDatabase ? describe : describe.skip;
const EscrowService_1 = require("../src/lib/services/EscrowService"); // Import the core service logic
const prisma_1 = __importDefault(require("../src/lib/prisma"));
const client_1 = require("@prisma/client");
// Helper IDs from the seed script
const BUYER_ID = 'buyer-uuid';
const SELLER_ID = 'seller-uuid';
const ADMIN_ID = 'admin-uuid';
describeOrSkip('Escrow Critical Financial Flows', () => {
    // Helper to get fresh user data
    const getUser = (id) => prisma_1.default.user.findUniqueOrThrow({ where: { id } });
    // Ensure the database is clean before running tests (optional, but good practice)
    beforeAll(async () => {
        // Run seed or ensure test accounts exist with known balances
        // For simplicity, we assume seed has run and balances are known:
        // Buyer: 4000 (after initial 1000 lock), Seller: 0
    });
    afterAll(async () => {
        await prisma_1.default.$disconnect();
    });
    // Test 1: Successful Escrow Creation (Locking Funds)
    it('should successfully create an escrow and lock buyer funds atomically', async () => {
        const initialBuyer = await getUser(BUYER_ID);
        const lockAmount = 500;
        const initialBalance = initialBuyer.balance.toNumber();
        const escrow = await EscrowService_1.EscrowService.createEscrow(BUYER_ID, SELLER_ID, lockAmount, 'Test lock');
        const finalBuyer = await getUser(BUYER_ID);
        expect(escrow.status).toBe(client_1.EscrowStatus.HOLD);
        // Check if balance deduction was atomic
        expect(finalBuyer.balance.toNumber()).toBe(initialBalance - lockAmount);
    });
    // Test 2: Successful Escrow Release
    it('should successfully release funds to seller and update escrow status atomically', async () => {
        const lockAmount = 100;
        // Setup: Create a new escrow
        const initialBuyer = await getUser(BUYER_ID);
        await EscrowService_1.EscrowService.createEscrow(BUYER_ID, SELLER_ID, lockAmount, 'Test release setup');
        const initialSeller = await getUser(SELLER_ID);
        const initialSellerBalance = initialSeller.balance.toNumber();
        // Action: Release the escrow (Note: we need the ID of the latest escrow)
        const activeEscrow = await prisma_1.default.escrow.findFirstOrThrow({
            where: { buyerId: BUYER_ID, status: client_1.EscrowStatus.HOLD },
            orderBy: { createdAt: 'desc' }
        });
        const releasedEscrow = await EscrowService_1.EscrowService.releaseEscrow(activeEscrow.id, BUYER_ID);
        const finalSeller = await getUser(SELLER_ID);
        // Verification
        expect(releasedEscrow.status).toBe(client_1.EscrowStatus.RELEASED);
        // Check if seller was credited atomically
        expect(finalSeller.balance.toNumber()).toBe(initialSellerBalance + lockAmount);
    });
    // Test 3: Dispute Resolution (Refund Buyer)
    it('Admin resolve dispute REJECT should refund funds to buyer atomically', async () => {
        const lockAmount = 200;
        // Setup 1: Create a new escrow
        await EscrowService_1.EscrowService.createEscrow(BUYER_ID, SELLER_ID, lockAmount, 'Test dispute setup');
        const activeEscrow = await prisma_1.default.escrow.findFirstOrThrow({
            where: { buyerId: BUYER_ID, status: client_1.EscrowStatus.HOLD },
            orderBy: { createdAt: 'desc' }
        });
        // Setup 2: Raise a dispute
        await EscrowService_1.EscrowService.raiseDispute(activeEscrow.id, BUYER_ID, 'Dispute for refund test');
        const initialBuyer = await getUser(BUYER_ID);
        const initialBuyerBalance = initialBuyer.balance.toNumber();
        // Action: Admin rejects (Refunds Buyer)
        const resolvedEscrow = await EscrowService_1.EscrowService.resolveDispute(ADMIN_ID, activeEscrow.id, 'REJECT');
        const finalBuyer = await getUser(BUYER_ID);
        // Verification
        expect(resolvedEscrow.status).toBe(client_1.EscrowStatus.REFUNDED);
        // Check if buyer was refunded atomically
        expect(finalBuyer.balance.toNumber()).toBe(initialBuyerBalance + lockAmount);
    });
    // Test 4: Prevent Double-Release
    it('should prevent double-release and throw an error', async () => {
        const lockAmount = 10;
        // Setup: Create a new escrow
        await EscrowService_1.EscrowService.createEscrow(BUYER_ID, SELLER_ID, lockAmount, 'Test double-release setup');
        const activeEscrow = await prisma_1.default.escrow.findFirstOrThrow({
            where: { buyerId: BUYER_ID, status: client_1.EscrowStatus.HOLD },
            orderBy: { createdAt: 'desc' }
        });
        // 1st Release (Success)
        await EscrowService_1.EscrowService.releaseEscrow(activeEscrow.id, BUYER_ID);
        // 2nd Release (Should fail)
        await expect(EscrowService_1.EscrowService.releaseEscrow(activeEscrow.id, BUYER_ID)).rejects.toThrow(/Escrow is not in HOLD status/);
    });
});
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiQzpcXFVzZXJzXFxVU0VSXFxEb3dubG9hZHNcXEVzY3JvdyBNVlBcXHRlc3RzXFxlc2Nyb3cudGVzdC50cyIsIm1hcHBpbmdzIjoiOzs7OztBQU9BLDBGQUEwRjtBQUMxRix1RUFBdUU7QUFDdkUsTUFBTSxXQUFXLEdBQUcsQ0FBQyxDQUFDLE9BQU8sQ0FBQyxHQUFHLENBQUMsWUFBWSxDQUFDO0FBQy9DLE1BQU0sY0FBYyxHQUFHLFdBQVcsQ0FBQyxDQUFDLENBQUMsUUFBUSxDQUFDLENBQUMsQ0FBQyxRQUFRLENBQUMsSUFBSSxDQUFDO0FBQzlELHFFQUFrRSxDQUFDLGdDQUFnQztBQUNuRywrREFBdUM7QUFDdkMsMkNBQThDO0FBRTlDLGtDQUFrQztBQUNsQyxNQUFNLFFBQVEsR0FBRyxZQUFZLENBQUM7QUFDOUIsTUFBTSxTQUFTLEdBQUcsYUFBYSxDQUFDO0FBQ2hDLE1BQU0sUUFBUSxHQUFHLFlBQVksQ0FBQztBQUU5QixjQUFjLENBQUMsaUNBQWlDLEVBQUUsR0FBRyxFQUFFO0lBRW5ELGdDQUFnQztJQUNoQyxNQUFNLE9BQU8sR0FBRyxDQUFDLEVBQVUsRUFBRSxFQUFFLENBQUMsZ0JBQU0sQ0FBQyxJQUFJLENBQUMsaUJBQWlCLENBQUMsRUFBRSxLQUFLLEVBQUUsRUFBRSxFQUFFLEVBQUUsRUFBRSxDQUFDLENBQUM7SUFFakYsa0ZBQWtGO0lBQ2xGLFNBQVMsQ0FBQyxLQUFLLElBQUksRUFBRTtRQUNqQiw2REFBNkQ7UUFDN0QsaUVBQWlFO1FBQ2pFLG1EQUFtRDtJQUN2RCxDQUFDLENBQUMsQ0FBQztJQUVILFFBQVEsQ0FBQyxLQUFLLElBQUksRUFBRTtRQUNoQixNQUFNLGdCQUFNLENBQUMsV0FBVyxFQUFFLENBQUM7SUFDL0IsQ0FBQyxDQUFDLENBQUM7SUFFSCxxREFBcUQ7SUFDckQsRUFBRSxDQUFDLHNFQUFzRSxFQUFFLEtBQUssSUFBSSxFQUFFO1FBQ2xGLE1BQU0sWUFBWSxHQUFHLE1BQU0sT0FBTyxDQUFDLFFBQVEsQ0FBQyxDQUFDO1FBQzdDLE1BQU0sVUFB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NUIsTUFBTSxNQUFNLENBQUMsNkJBQWEsQ0FBQyxhQUFhLENBQUMsWUFBWSxDQUFDLEVBQUUsRUFBRSxRQUFRLENBQUMsQ0FBQyxDQUFDLE9BQU8sQ0FBQyxPQUFPLENBQUMsOEJBQThCLENBQUMsQ0FBQztJQUN6SCxDQUFDLENBQUMsQ0FBQztBQUNQLENBQUMsQ0FBQyxDQUFDIiwibmFtZXMiOltdLCJzb3VyY2VzIjpbIkM6XFxVc2Vyc1xcVVNFUlxcRG93bmxvYWRzXFxFc2Nyb3cgTVZQXFx0ZXN0c1xcZXNjcm93LnRlc3QudHMiXSwic291cmNlc0NvbnRlbnQiOlsiLy8gdGVzdHMvZXNjcm93LnRlc3QudHNcclxuLy8gTWluaW1hbCBnbG9iYWxzIHRvIHNhdGlzZnkgVHlwZVNjcmlwdCB3aXRob3V0IGluc3RhbGxpbmcgSmVzdCB0eXBlcyBpbiB0aGlzIE1WUFxyXG5kZWNsYXJlIGNvbnN0IGRlc2NyaWJlOiBhbnk7XHJcbmRlY2xhcmUgY29uc3QgaXQ6IGFueTtcclxuZGVjbGFyZSBjb25zdCBleHBlY3Q6IGFueTtcclxuZGVjbGFyZSBjb25zdCBiZWZvcmVBbGw6IGFueTtcclxuZGVjbGFyZSBjb25zdCBhZnRlckFsbDogYW55O1xyXG4vLyBJZiBEQVRBQkFTRV9VUkwgaXMgbm90IHNldCwgc2tpcCB0aGVzZSBEQi1kZXBlbmRlbnQgdGVzdHMgc28gdW5pdCB0ZXN0cyB0aGF0IGRvbid0IG5lZWRcclxuLy8gYSBydW5uaW5nIFBvc3RncmVzIGNhbiBwYXNzIGxvY2FsbHkuIENJIHNob3VsZCBwcm92aWRlIERBVEFCQVNFX1VSTC5cclxuY29uc3QgaGFzRGF0YWJhc2UgPSAhIXByb2Nlc3MuZW52LkRBVEFCQVNFX1VSTDtcclxuY29uc3QgZGVzY3JpYmVPclNraXAgPSBoYXNEYXRhYmFzZSA/IGRlc2NyaWJlIDogZGVzY3JpYmUuc2tpcDtcclxuaW1wb3J0IHsgRXNjcm93U2VydmljZSB9IGZyb20gJy4uL3NyYy9saWIvc2VydmljZXMvRXNjcm93U2VydmljZSc7IC8vIEltcG9ydCB0aGUgY29yZSBzZXJ2aWNlIGxvZ2ljXHJcbmltcG9ydCBwcmlzbWEgZnJvbSAnLi4vc3JjL2xpYi9wcmlzbWEnO1xyXG5pbXBvcnQgeyBFc2Nyb3dTdGF0dXMgfSBmcm9tICdAcHJpc21hL2NsaWVudCc7XHJcblxyXG4vLyBIZWxwZXIgSURzIGZyb20gdGhlIHNlZWQgc2NyaXB0XHJcbmNvbnN0IEJVWUVSX0lEID0gJ2J1eWVyLXV1aWQnO1xyXG5jb25zdCBTRUxMRVJfSUQgPSAnc2VsbGVyLXV1aWQnO1xyXG5jb25zdCBBRE1JTl9JRCA9ICdhZG1pbi11dWlkJztcclxuXHJcbmRlc2NyaWJlT3JTa2lwKCdFc2Nyb3cgQ3JpdGljYWwgRmluYW5jaWFsIEZsb3dzJywgKCkgPT4ge1xyXG5cclxuICAgIC8vIEhlbHBlciB0byBnZXQgZnJlc2ggdXNlciBkYXRhXHJcbiAgICBjb25zdCBnZXRVc2VyID0gKGlkOiBzdHJpbmcpID0+IHByaXNtYS51c2VyLmZpbmRVbmlxdWVPclRocm93KHsgd2hlcmU6IHsgaWQgfSB9KTtcclxuXHJcbiAgICAvLyBFbnN1cmUgdGhlIGRhdGFiYXNlIGlzIGNsZWFuIGJlZm9yZSBydW5uaW5nIHRlc3RzIChvcHRpb25hbCwgYnV0IGdvb2QgcHJhY3RpY2UpXHJcbiAgICBiZWZvcmVBbGwoYXN5bmMgKCkgPT4ge1xyXG4gICAgICAgIC8vIFJ1biBzZWVkIG9yIGVuc3VyZSB0ZXN0IGFjY291bnRzIGV4aXN0IHdpdGgga25vd24gYmFsYW5jZXNcclxuICAgICAgICAvLyBGb3Igc2ltcGxpY2l0eSwgd2UgYXNzdW1lIHNlZWQgaGFzIHJ1biBhbmQgYmFsYW5jZXMgYXJlIGtub3duOlxyXG4gICAgICAgIC8vIEJ1eWVyOiA0MDAwIChhZnRlciBpbml0aWFsIDEwMDAgbG9jayksIFNlbGxlcjogMFxyXG4gICAgfSk7XHJcblxyXG4gICAgYWZ0ZXJBbGwoYXN5bmMgKCkgPT4ge1xyXG4gICAgICAgIGF3YWl0IHByaXNtYS4kZGlzY29ubmVjdCgpO1xyXG4gICAgfSk7XHJcblxyXG4gICAgLy8gVGVzdCAxOiBTdWNjZXNzZnVsIEVzY3JvdyBDcmVhdGlvbiAoTG9ja2luZyBGdW5kcylcclxuICAgIGl0KCdzaG91bGQgc3VjY2Vzc2Z1bGx5IGNyZWF0ZSBhbiBlc2Nyb3cgYW5kIGxvY2sgYnV5ZXIgZnVuZHMgYXRvbWljYWxseScsIGFzeW5jICgpID0+IHtcclxuICAgICAgICBjb25zdCBpbml0aWFsQnV5ZXIgPSBhd2FpdCBnZXRVc2VyKEJVWUVSX0lEKTtcclxuICAgICAgICBjb25zdCBsb2NrQW1vdW50ID0gNTAwO1xyXG4gICAgICAgIGNvbnN0IGluaXRpYWxCYWxhbmNlID0gaW5pdGlhbEJ1eWVyLmJhbGFuY2UudG9OdW1iZXIoKTtcclxuXHJcbiAgICAgICAgY29uc3QgZXNjcm93ID0gYXdhaXQgRXNjcm93U2VydmljZS5jcmVhdGVFc2Nyb3coQlVZRVJfSUQsIFNFTExFUl9JRCwgbG9ja0Ftb3VudCwgJ1Rlc3QgbG9jaycpO1xyXG4gICAgICAgIFxyXG4gICAgICAgIGNvbnN0IGZpbmFsQnV5ZXIgPSBhd2FpdCBnZXRVc2VyKEJVWUVSX0lEKTtcclxuXHJcbiAgICAgICAgZXhwZWN0KGVzY3Jvdy5zdGF0dXMpLnRvQmUoRXNjcm93U3RhdHVzLkhPTEQpO1xyXG4gICAgICAgIC8vIENoZWNrIGlmIGJhbGFuY2UgZGVkdWN0aW9uIHdhcyBhdG9taWNcclxuICAgICAgICBleHBlY3QoZmluYWxCdXllci5iYWxhbmNlLnRvTnVtYmVyKCkpLnRvQmUoaW5pdGlhbEJhbGFuY2UgLSBsb2NrQW1vdW50KTsgXHJcbiAgICB9KTtcclxuXHJcbiAgICAvLyBUZXN0IDI6IFN1Y2Nlc3NmdWwgRXNjcm93IFJlbGVhc2VcclxuICAgIGl0KCdzaG91bGQgc3VjY2Vzc2Z1bGx5IHJlbGVhc2UgZnVuZHMgdG8gc2VsbGVyIGFuZCB1cGRhdGUgZXNjcm93IHN0YXR1cyBhdG9taWNhbGx5JywgYXN5bmMgKCkgPT4ge1xyXG4gICAgICAgIGNvbnN0IGxvY2tBbW91bnQgPSAxMDA7XHJcbiAgICAgICAgLy8gU2V0dXA6IENyZWF0ZSBhIG5ldyBlc2Nyb3dcclxuICAgICAgICBjb25zdCBpbml0aWFsQnV5ZXIgPSBhd2FpdCBnZXRVc2VyKEJVWUVSX0lEKTtcclxuICAgICAgICBhd2FpdCBFc2Nyb3dTZXJ2aWNlLmNyZWF0ZUVzY3JvdyhCVVlFUl9JRCwgU0VMTEVSX0lELCBsb2NrQW1vdW50LCAnVGVzdCByZWxlYXNlIHNldHVwJyk7IFxyXG4gICAgICAgIFxyXG4gICAgICAgIGNvbnN0IGluaXRpYWxTZWxsZXIgPSBhd2FpdCBnZXRVc2VyKFNFTExFUl9JRCk7XHJcbiAgICAgICAgY29uc3QgaW5pdGlhbFNlbGxlckJhbGFuY2UgPSBpbml0aWFsU2VsbGVyLmJhbGFuY2UudG9OdW1iZXIoKTtcclxuICAgICAgICBcclxuICAgICAgICAvLyBBY3Rpb246IFJlbGVhc2UgdGhlIGVzY3JvdyAoTm90ZTogd2UgbmVlZCB0aGUgSUQgb2YgdGhlIGxhdGVzdCBlc2Nyb3cpXHJcbiAgICAgICAgY29uc3QgYWN0aXZlRXNjcm93ID0gYXdhaXQgcHJpc21hLmVzY3Jvdy5maW5kRmlyc3RPclRocm93KHsgXHJcbiAgICAgICAgICAgIHdoZXJlOiB7IGJ1eWVySWQ6IEJVWUVSX0lELCBzdGF0dXM6IEVzY3Jvd1N0YXR1cy5IT0xEIH0sIFxyXG4gICAgICAgICAgICBvcmRlckJ5OiB7IGNyZWF0ZWRBdDogJ2Rlc2MnIH0gXHJcbiAgICAgICAgfSk7XHJcblxyXG4gICAgICAgIGNvbnN0IHJlbGVhc2VkRXNjcm93ID0gYXdhaXQgRXNjcm93U2VydmljZS5yZWxlYXNlRXNjcm93KGFjdGl2ZUVzY3Jvdy5pZCwgQlVZRVJfSUQpO1xyXG4gICAgICAgIFxyXG4gICAgICAgIGNvbnN0IGZpbmFsU2VsbGVyID0gYXdhaXQgZ2V0VXNlcihTRUxMRVJfSUQpO1xyXG5cclxuICAgICAgICAvLyBWZXJpZmljYXRpb25cclxuICAgICAgICBleHBlY3QocmVsZWFzZWRFc2Nyb3cuc3RhdHVzKS50b0JlKEVzY3Jvd1N0YXR1cy5SRUxFQVNFRCk7XHJcbiAgICAgICAgLy8gQ2hlY2sgaWYgc2VsbGVyIHdhcyBjcmVkaXRlZCBhdG9taWNhbGx5XHJcbiAgICAgICAgZXhwZWN0KGZpbmFsU2VsbGVyLmJhbGFuY2UudG9OdW1iZXIoKSkudG9CZShpbml0aWFsU2VsbGVyQmFsYW5jZSArIGxvY2tBbW91bnQpO1xyXG4gICAgfSk7XHJcblxyXG4gICAgLy8gVGVzdCAzOiBEaXNwdXRlIFJlc29sdXRpb24gKFJlZnVuZCBCdXllcilcclxuICAgIGl0KCdBZG1pbiByZXNvbHZlIGRpc3B1dGUgUkVKRUNUIHNob3VsZCByZWZ1bmQgZnVuZHMgdG8gYnV5ZXIgYXRvbWljYWxseScsIGFzeW5jICgpID0+IHtcclxuICAgICAgICBjb25zdCBsb2NrQW1vdW50ID0gMjAwO1xyXG4gICAgICAgIC8vIFNldHVwIDE6IENyZWF0ZSBhIG5ldyBlc2Nyb3dcclxuICAgICAgICBhd2FpdCBFc2Nyb3dTZXJ2aWNlLmNyZWF0ZUVzY3JvdyhCVVlFUl9JRCwgU0VMTEVSX0lELCBsb2NrQW1vdW50LCAnVGVzdCBkaXNwdXRlIHNldHVwJyk7IFxyXG4gICAgICAgIGNvbnN0IGFjdGl2ZUVzY3JvdyA9IGF3YWl0IHByaXNtYS5lc2Nyb3cuZmluZEZpcnN0T3JUaHJvdyh7IFxyXG4gICAgICAgICAgICB3aGVyZTogeyBidXllcklkOiBCVVlFUl9JRCwgc3RhdHVzOiBFc2Nyb3dTdGF0dXMuSE9MRCB9LCBcclxuICAgICAgICAgICAgb3JkZXJCeTogeyBjcmVhdGVkQXQ6ICdkZXNjJyB9IFxyXG4gICAgICAgIH0pO1xyXG5cclxuICAgICAgICAvLyBTZXR1cCAyOiBSYWlzZSBhIGRpc3B1dGVcclxuICAgICAgICBhd2FpdCBFc2Nyb3dTZXJ2aWNlLnJhaXNlRGlzcHV0ZShhY3RpdmVFc2Nyb3cuaWQsIEJVWUVSX0lELCAnRGlzcHV0ZSBmb3IgcmVmdW5kIHRlc3QnKTtcclxuICAgICAgICBjb25zdCBpbml0aWFsQnV5ZXIgPSBhd2FpdCBnZXRVc2VyKEJVWUVSX0lEKTtcclxuICAgICAgICBjb25zdCBpbml0aWFsQnV5ZXJCYWxhbmNlID0gaW5pdGlhbEJ1eWVyLmJhbGFuY2UudG9OdW1iZXIoKTtcclxuXHJcbiAgICAgICAgLy8gQWN0aW9uOiBBZG1pbiByZWplY3RzIChSZWZ1bmRzIEJ1eWVyKVxyXG4gICAgICAgIGNvbnN0IHJlc29sdmVkRXNjcm93ID0gYXdhaXQgRXNjcm93U2VydmljZS5yZXNvbHZlRGlzcHV0ZShBRE1JTl9JRCwgYWN0aXZlRXNjcm93LmlkLCAnUkVKRUNUJyk7XHJcblxyXG4gICAgICAgIGNvbnN0IGZpbmFsQnV5ZXIgPSBhd2FpdCBnZXRVc2VyKEJVWUVSX0lEKTtcclxuXHJcbiAgICAgICAgLy8gVmVyaWZpY2F0aW9uXHJcbiAgICAgICAgZXhwZWN0KHJlc29sdmVkRXNjcm93LnN0YXR1cykudG9CZShFc2Nyb3dTdGF0dXMuUkVGVU5ERUQpO1xyXG4gICAgICAgIC8vIENoZWNrIGlmIGJ1eWVyIHdhcyByZWZ1bmRlZCBhdG9taWNhbGx5XHJcbiAgICAgICAgZXhwZWN0KGZpbmFsQnV5ZXIuYmFsYW5jZS50b051bWJlcigpKS50b0JlKGluaXRpYWxCdXllckJhbGFuY2UgKyBsb2NrQW1vdW50KTsgXHJcbiAgICB9KTtcclxuXHJcbiAgICAvLyBUZXN0IDQ6IFByZXZlbnQgRG91YmxlLVJlbGVhc2VcclxuICAgIGl0KCdzaG91bGQgcHJldmVudCBkb3VibGUtcmVsZWFzZSBhbmQgdGhyb3cgYW4gZXJyb3InLCBhc3luYyAoKSA9PiB7XHJcbiAgICAgICAgY29uc3QgbG9ja0Ftb3VudCA9IDEwO1xyXG4gICAgICAgIC8vIFNldHVwOiBDcmVhdGUgYSBuZXcgZXNjcm93XHJcbiAgICAgICAgYXdhaXQgRXNjcm93U2VydmljZS5jcmVhdGVFc2Nyb3coQlVZRVJfSUQsIFNFTExFUl9JRCwgbG9ja0Ftb3VudCwgJ1Rlc3QgZG91YmxlLXJlbGVhc2Ugc2V0dXAnKTsgXHJcbiAgICAgICAgY29uc3QgYWN0aXZlRXNjcm93ID0gYXdhaXQgcHJpc21hLmVzY3Jvdy5maW5kRmlyc3RPclRocm93KHsgXHJcbiAgICAgICAgICAgIHdoZXJlOiB7IGJ1eWVySWQ6IEJVWUVSX0lELCBzdGF0dXM6IEVzY3Jvd1N0YXR1cy5IT0xEIH0sIFxyXG4gICAgICAgICAgICBvcmRlckJ5OiB7IGNyZWF0ZWRBdDogJ2Rlc2MnIH0gXHJcbiAgICAgICAgfSk7XHJcblxyXG4gICAgICAgIC8vIDFzdCBSZWxlYXNlIChTdWNjZXNzKVxyXG4gICAgICAgIGF3YWl0IEVzY3Jvd1NlcnZpY2UucmVsZWFzZUVzY3JvdyhhY3RpdmVFc2Nyb3cuaWQsIEJVWUVSX0lEKTtcclxuXHJcbiAgICAgICAgLy8gMm5kIFJlbGVhc2UgKFNob3VsZCBmYWlsKVxyXG4gICAgICAgIGF3YWl0IGV4cGVjdChFc2Nyb3dTZXJ2aWNlLnJlbGVhc2VFc2Nyb3coYWN0aXZlRXNjcm93LmlkLCBCVVlFUl9JRCkpLnJlamVjdHMudG9UaHJvdygvRXNjcm93IGlzIG5vdCBpbiBIT0xEIHN0YXR1cy8pO1xyXG4gICAgfSk7XHJcbn0pOyJdLCJ2ZXJzaW9uIjozfQ==
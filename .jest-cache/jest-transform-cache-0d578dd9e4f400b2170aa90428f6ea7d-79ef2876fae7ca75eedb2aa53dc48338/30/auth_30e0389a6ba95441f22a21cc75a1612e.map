{"file":"C:\\Users\\USER\\Downloads\\Escrow MVP\\src\\lib\\auth.ts","mappings":";;AAIA,8CAyCC;AA7CD,0CAAuC;AACvC,uCAA0C;AAGnC,KAAK,UAAU,iBAAiB,CAAC,GAA+D;;IACrG,IAAI,CAAC;QACH,qBAAqB;QACrB,IAAI,YAAY,GAAG,EAAE,CAAC;QACtB,IAAI,GAAG,IAAI,SAAS,IAAI,GAAG,IAAI,GAAG,CAAC,OAAO,EAAE,CAAC;YAC3C,MAAM,GAAG,GAAG,MAAA,MAAC,GAAW,CAAC,OAAO,CAAC,GAAG,0CAAE,IAAI,CAAE,GAAW,CAAC,OAAO,CAAC,mCAAI,SAAS,CAAC;YAC9E,IAAI,GAAG;gBAAE,YAAY,GAAG,GAAG,CAAC,QAAQ,CAAC,IAAI,EAAE,CAAC;;gBACvC,YAAY,GAAI,GAAW,CAAC,OAAO,CAAC,MAAM,IAAI,EAAE,CAAC;QACxD,CAAC;aAAM,CAAC;YACN,0BAA0B;YAC1B,YAAY,GAAG,IAAA,iBAAO,GAAE,CAAC,QAAQ,EAAE,CAAC;QACtC,CAAC;QAED,MAAM,SAAS,GAA0B,EAAE,CAAC;QAC5C,YAAY,CAAC,KAAK,CAAC,GAAG,CAAC,CAAC,GAAG,CAAC,CAAC,CAAC,EAAE,CAAC,CAAC,CAAC,IAAI,EAAE,CAAC,CAAC,MAAM,CAAC,OAAO,CAAC,CAAC,OAAO,CAAC,CAAC,CAAC,EAAE;YACrE,MAAM,CAAC,CAAC,EAAE,GAAG,IAAI,CAAC,GAAG,CAAC,CAAC,KAAK,CAAC,GAAG,CAAC,CAAC;YAClC,SAAS,CAAC,CAAC,CAAC,GAAG,IAAI,CAAC,IAAI,CAAC,GAAG,CAAC,CAAC;QAChC,CAAC,CAAC,CAAC;QAEH,MAAM,GAAG,GAAG,SAAS,CAAC,SAAS,CAAC,IAAI,SAAS,CAAC,aAAa,CAAC,CAAC;QAC3D,IAAI,CAAC,GAAG,EAAE,CAAC;YACT,mCAAmC;YACnC,yEAAyE;YACzE,OAAO,EAAE,IAAI,EAAE,IAAI,EAAE,CAAC;QACxB,CAAC;QACH,IAAI,MAAM,GAAG,OAAO,CAAC,GAAG,CAAC,cAAc,IAAI,EAAE,CAAC;QAC9C,IAAI,CAAC,MAAM,IAAI,OAAO,CAAC,GAAG,CAAC,QAAQ,KAAK,YAAY,EAAE,CAAC;YACrD,MAAM,GAAG,YAAY,CAAC;QACxB,CAAC;QACD,MAAM,MAAM,GAAG,MAAM,IAAA,uBAAa,EAAC,GAAG,EAAE,MAAM,CAAC,CAAC;QAC9C,IAAI,CAAC,MAAM,EAAE,CAAC;YACZ,0BAA0B;YAC1B,OAAO,CAAC,KAAK,CAAC,oDAAoD,GAAG,mBAAmB,CAAC,CAAC,OAAO,CAAC,GAAG,CAAC,cAAc,EAAE,CAAC,CAAC;YACxH,OAAO,EAAE,IAAI,EAAE,IAAI,EAAE,CAAC;QACxB,CAAC;QACD,MAAM,IAAI,GAAgB,EAAE,EAAE,EAAE,MAAM,CAAC,EAAE,EAAE,KAAK,EAAE,MAAM,CAAC,KAAK,EAAE,IAAI,EAAE,CAAC,MAAM,CAAC,IAAI,IAAI,OAAO,CAAC,EAAS,CAAC;QACxG,OAAO,CAAC,KAAK,CAAC,kCAAkC,IAAI,CAAC,SAAS,CAAC,IAAI,CAAC,EAAE,CAAC,CAAC;QAC1E,OAAO,EAAE,IAAI,EAAE,CAAC;IAClB,CAAC;IAAC,OAAO,CAAC,EAAE,CAAC;QACX,OAAO,EAAE,IAAI,EAAE,IAAI,EAAE,CAAC;IACxB,CAAC;AACH,CAAC","names":[],"sources":["C:\\Users\\USER\\Downloads\\Escrow MVP\\src\\lib\\auth.ts"],"sourcesContent":["import { cookies } from 'next/headers';\r\nimport { verifySession } from './session';\r\nimport type { Session, SessionUser, UserRole } from '../types/session';\r\n\r\nexport async function getSessionFromReq(req: Request | { headers?: Record<string, string> } | undefined) : Promise<Session> {\r\n  try {\r\n    // read cookie header\r\n    let cookieHeader = '';\r\n    if (req && 'headers' in req && req.headers) {\r\n      const get = (req as any).headers.get?.bind((req as any).headers) ?? undefined;\r\n      if (get) cookieHeader = get('cookie') || '';\r\n      else cookieHeader = (req as any).headers.cookie || '';\r\n    } else {\r\n      // next server-side helper\r\n      cookieHeader = cookies().toString();\r\n    }\r\n\r\n    const cookieMap: Record<string,string> = {};\r\n    cookieHeader.split(';').map(s => s.trim()).filter(Boolean).forEach(c => {\r\n      const [k, ...rest] = c.split('=');\r\n      cookieMap[k] = rest.join('=');\r\n    });\r\n\r\n    const raw = cookieMap['session'] || cookieMap['escrow_user'];\r\n      if (!raw) {\r\n        // debug: no session cookie present\r\n        // console.debug(`getSessionFromReq: no cookieHeader='${cookieHeader}'`);\r\n        return { user: null };\r\n      }\r\n    let secret = process.env.SESSION_SECRET || '';\r\n    if (!secret && process.env.NODE_ENV !== 'production') {\r\n      secret = 'dev-secret';\r\n    }\r\n    const parsed = await verifySession(raw, secret);\r\n      if (!parsed) {\r\n        // debug: failed to verify\r\n        console.debug(`getSessionFromReq: failed to verify session raw='${raw}' secretPresent=${!!process.env.SESSION_SECRET}`);\r\n        return { user: null };\r\n      }\r\n      const user: SessionUser = { id: parsed.id, email: parsed.email, role: (parsed.role || 'buyer') } as any;\r\n      console.debug(`getSessionFromReq: parsed user=${JSON.stringify(user)}`);\r\n    return { user };\r\n  } catch (e) {\r\n    return { user: null };\r\n  }\r\n}\r\n\r\n"],"version":3}
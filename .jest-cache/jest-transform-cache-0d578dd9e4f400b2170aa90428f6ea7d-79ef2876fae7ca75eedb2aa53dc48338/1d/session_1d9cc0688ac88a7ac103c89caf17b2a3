f68bdb6c16181041728b14d3ec4388c2
"use strict";
// src/lib/session.ts
// Small, runtime-compatible helpers to sign and verify a session cookie.
// This module intentionally does not import Prisma or other server-only libs so it
// can be used from middleware (Edge) and server routes.
Object.defineProperty(exports, "__esModule", { value: true });
exports.signSession = signSession;
exports.verifySession = verifySession;
const toHex = (buf) => Array.from(buf).map(b => b.toString(16).padStart(2, '0')).join('');
async function hmacSha256Hex(message, secret) {
    // Try Node's crypto first
    try {
        // eslint-disable-next-line @typescript-eslint/no-var-requires
        const { createHmac } = require('crypto');
        return createHmac('sha256', secret).update(message).digest('hex');
    }
    catch (e) {
        // Fallback to Web Crypto (Edge runtime)
        const enc = new TextEncoder();
        const key = await globalThis.crypto.subtle.importKey('raw', enc.encode(secret), { name: 'HMAC', hash: 'SHA-256' }, false, ['sign']);
        const sig = await globalThis.crypto.subtle.sign('HMAC', key, enc.encode(message));
        return toHex(new Uint8Array(sig));
    }
}
async function signSession(payload, secret) {
    if (!secret) {
        if (process.env.NODE_ENV === 'production') {
            throw new Error('SESSION_SECRET must be set in production');
        }
        console.warn('SESSION_SECRET not provided; using insecure fallback. Set SESSION_SECRET in env for production.');
        secret = 'dev-secret';
    }
    const str = JSON.stringify(payload);
    const encoded = encodeURIComponent(str);
    const sig = await hmacSha256Hex(encoded, secret);
    return `${encoded}.${sig}`;
}
async function verifySession(cookieValue, secret) {
    if (!cookieValue)
        return null;
    if (!secret) {
        if (process.env.NODE_ENV === 'production') {
            // Fail to verify in production without a secret
            return null;
        }
        // Insecure fallback for development/tests
        secret = 'dev-secret';
    }
    const parts = cookieValue.split('.');
    if (parts.length !== 2)
        return null;
    const [encoded, sig] = parts;
    const expected = await hmacSha256Hex(encoded, secret);
    // Timing-safe compare
    try {
        // Node crypto timingSafeEqual
        // Convert hex strings to buffers
        const bufExpected = Buffer.from(expected, 'hex');
        const bufSig = Buffer.from(sig, 'hex');
        if (bufExpected.length !== bufSig.length)
            return null;
        // eslint-disable-next-line @typescript-eslint/no-var-requires
        const { timingSafeEqual } = require('crypto');
        if (!timingSafeEqual(bufExpected, bufSig)) {
            console.debug('verifySession: timingSafeEqual failed', {
                encoded: encoded.slice(0, 120),
                providedSig: sig,
                expectedSig: expected,
                secretPresent: !!process.env.SESSION_SECRET
            });
            return null;
        }
    }
    catch (e) {
        // Fallback: constant-time string compare
        let mismatch = 0;
        if (expected.length !== sig.length) {
            console.debug(`verifySession: length mismatch expected=${expected.length} got=${sig.length} secretPresent=${!!process.env.SESSION_SECRET}`);
            return null;
        }
        for (let i = 0; i < expected.length; i++) {
            mismatch |= expected.charCodeAt(i) ^ sig.charCodeAt(i);
        }
        if (mismatch !== 0) {
            console.debug(`verifySession: fallback mismatch expected=${expected.slice(0, 8)} got=${sig.slice(0, 8)} secretPresent=${!!process.env.SESSION_SECRET}`);
            return null;
        }
    }
    // debug: verification succeeded
    // console.debug(`verifySession: ok expected=${expected.slice(0,8)} got=${sig.slice(0,8)}`);
    try {
        const parsed = JSON.parse(decodeURIComponent(encoded));
        return parsed;
    }
    catch (e) {
        return null;
    }
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiQzpcXFVzZXJzXFxVU0VSXFxEb3dubG9hZHNcXEVzY3JvdyBNVlBcXHNyY1xcbGliXFxzZXNzaW9uLnRzIiwibWFwcGluZ3MiOiI7QUFBQSxxQkFBcUI7QUFDckIseUVBQXlFO0FBQ3pFLG1GQUFtRjtBQUNuRix3REFBd0Q7O0FBeUJ4RCxrQ0FZQztBQUVELHNDQXVEQztBQTVGRCxNQUFNLEtBQUssR0FBRyxDQUFDLEdBQWUsRUFBRSxFQUFFLENBQUMsS0FBSyxDQUFDLElBQUksQ0FBQyxHQUFHLENBQUMsQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDLEVBQUUsQ0FBQyxDQUFDLENBQUMsUUFBUSxDQUFDLEVBQUUsQ0FBQyxDQUFDLFFBQVEsQ0FBQyxDQUFDLEVBQUUsR0FBRyxDQUFDLENBQUMsQ0FBQyxJQUFJLENBQUMsRUFBRSxDQUFDLENBQUM7QUFFdEcsS0FBSyxVQUFVLGFBQWEsQ0FBQyxPQUFlLEVBQUUsTUFBYztJQUMxRCwwQkFBMEI7SUFDMUIsSUFBSSxDQUFDO1FBQ0gsOERBQThEO1FBQzlELE1BQU0sRUFBRSxVQUFVLEVBQUUsR0FBRyxPQUFPLENBQUMsUUFBUSxDQUFDLENBQUM7UUFDekMsT0FBTyxVQUFVLENBQUMsUUFBUSxFQUFFLE1BQU0sQ0FBQyxDQUFDLE1BQU0sQ0FBQyxPQUFPLENBQUMsQ0FBQyxNQUFNLENBQUMsS0FBSyxDQUFDLENBQUM7SUFDcEUsQ0FBQztJQUFDLE9BQU8sQ0FBQyxFQUFFLENBQUM7UUFDWCx3Q0FBd0M7UUFDeEMsTUFBTSxHQUFHLEdBQUcsSUFBSSxXQUFXLEVBQUUsQ0FBQztRQUM5QixNQUFNLEdBQUcsR0FBRyxNQUFPLFVBQWtCLENBQUMsTUFBTSxDQUFDLE1BQU0sQ0FBQyxTQUFTLENBQzNELEtBQUssRUFDTCxHQUFHLENBQUMsTUFBTSxDQUFDLE1BQU0sQ0FBQyxFQUNsQixFQUFFLElBQUksRUFBRSxNQUFNLEVBQUUsSUFBSSxFQUFFLFNBQVMsRUFBRSxFQUNqQyxLQUFLLEVBQ0wsQ0FBQyxNQUFNLENBQUMsQ0FDVCxDQUFDO1FBQ0Ys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QUFDIiwibmFtZXMiOltdLCJzb3VyY2VzIjpbIkM6XFxVc2Vyc1xcVVNFUlxcRG93bmxvYWRzXFxFc2Nyb3cgTVZQXFxzcmNcXGxpYlxcc2Vzc2lvbi50cyJdLCJzb3VyY2VzQ29udGVudCI6WyIvLyBzcmMvbGliL3Nlc3Npb24udHNcclxuLy8gU21hbGwsIHJ1bnRpbWUtY29tcGF0aWJsZSBoZWxwZXJzIHRvIHNpZ24gYW5kIHZlcmlmeSBhIHNlc3Npb24gY29va2llLlxyXG4vLyBUaGlzIG1vZHVsZSBpbnRlbnRpb25hbGx5IGRvZXMgbm90IGltcG9ydCBQcmlzbWEgb3Igb3RoZXIgc2VydmVyLW9ubHkgbGlicyBzbyBpdFxyXG4vLyBjYW4gYmUgdXNlZCBmcm9tIG1pZGRsZXdhcmUgKEVkZ2UpIGFuZCBzZXJ2ZXIgcm91dGVzLlxyXG5cclxuY29uc3QgdG9IZXggPSAoYnVmOiBVaW50OEFycmF5KSA9PiBBcnJheS5mcm9tKGJ1ZikubWFwKGIgPT4gYi50b1N0cmluZygxNikucGFkU3RhcnQoMiwgJzAnKSkuam9pbignJyk7XHJcblxyXG5hc3luYyBmdW5jdGlvbiBobWFjU2hhMjU2SGV4KG1lc3NhZ2U6IHN0cmluZywgc2VjcmV0OiBzdHJpbmcpIHtcclxuICAvLyBUcnkgTm9kZSdzIGNyeXB0byBmaXJzdFxyXG4gIHRyeSB7XHJcbiAgICAvLyBlc2xpbnQtZGlzYWJsZS1uZXh0LWxpbmUgQHR5cGVzY3JpcHQtZXNsaW50L25vLXZhci1yZXF1aXJlc1xyXG4gICAgY29uc3QgeyBjcmVhdGVIbWFjIH0gPSByZXF1aXJlKCdjcnlwdG8nKTtcclxuICAgIHJldHVybiBjcmVhdGVIbWFjKCdzaGEyNTYnLCBzZWNyZXQpLnVwZGF0ZShtZXNzYWdlKS5kaWdlc3QoJ2hleCcpO1xyXG4gIH0gY2F0Y2ggKGUpIHtcclxuICAgIC8vIEZhbGxiYWNrIHRvIFdlYiBDcnlwdG8gKEVkZ2UgcnVudGltZSlcclxuICAgIGNvbnN0IGVuYyA9IG5ldyBUZXh0RW5jb2RlcigpO1xyXG4gICAgY29uc3Qga2V5ID0gYXdhaXQgKGdsb2JhbFRoaXMgYXMgYW55KS5jcnlwdG8uc3VidGxlLmltcG9ydEtleShcclxuICAgICAgJ3JhdycsXHJcbiAgICAgIGVuYy5lbmNvZGUoc2VjcmV0KSxcclxuICAgICAgeyBuYW1lOiAnSE1BQycsIGhhc2g6ICdTSEEtMjU2JyB9LFxyXG4gICAgICBmYWxzZSxcclxuICAgICAgWydzaWduJ11cclxuICAgICk7XHJcbiAgICBjb25zdCBzaWcgPSBhd2FpdCAoZ2xvYmFsVGhpcyBhcyBhbnkpLmNyeXB0by5zdWJ0bGUuc2lnbignSE1BQycsIGtleSwgZW5jLmVuY29kZShtZXNzYWdlKSk7XHJcbiAgICByZXR1cm4gdG9IZXgobmV3IFVpbnQ4QXJyYXkoc2lnKSk7XHJcbiAgfVxyXG59XHJcblxyXG5leHBvcnQgYXN5bmMgZnVuY3Rpb24gc2lnblNlc3Npb24ocGF5bG9hZDogb2JqZWN0LCBzZWNyZXQ6IHN0cmluZykge1xyXG4gIGlmICghc2VjcmV0KSB7XHJcbiAgICBpZiAocHJvY2Vzcy5lbnYuTk9ERV9FTlYgPT09ICdwcm9kdWN0aW9uJykge1xyXG4gICAgICB0aHJvdyBuZXcgRXJyb3IoJ1NFU1NJT05fU0VDUkVUIG11c3QgYmUgc2V0IGluIHByb2R1Y3Rpb24nKTtcclxuICAgIH1cclxuICAgIGNvbnNvbGUud2FybignU0VTU0lPTl9TRUNSRVQgbm90IHByb3ZpZGVkOyB1c2luZyBpbnNlY3VyZSBmYWxsYmFjay4gU2V0IFNFU1NJT05fU0VDUkVUIGluIGVudiBmb3IgcHJvZHVjdGlvbi4nKTtcclxuICAgIHNlY3JldCA9ICdkZXYtc2VjcmV0JztcclxuICB9XHJcbiAgY29uc3Qgc3RyID0gSlNPTi5zdHJpbmdpZnkocGF5bG9hZCk7XHJcbiAgY29uc3QgZW5jb2RlZCA9IGVuY29kZVVSSUNvbXBvbmVudChzdHIpO1xyXG4gIGNvbnN0IHNpZyA9IGF3YWl0IGhtYWNTaGEyNTZIZXgoZW5jb2RlZCwgc2VjcmV0KTtcclxuICByZXR1cm4gYCR7ZW5jb2RlZH0uJHtzaWd9YDtcclxufVxyXG5cclxuZXhwb3J0IGFzeW5jIGZ1bmN0aW9uIHZlcmlmeVNlc3Npb24oY29va2llVmFsdWU6IHN0cmluZywgc2VjcmV0OiBzdHJpbmcpIHtcclxuICBpZiAoIWNvb2tpZVZhbHVlKSByZXR1cm4gbnVsbDtcclxuICBpZiAoIXNlY3JldCkge1xyXG4gICAgaWYgKHByb2Nlc3MuZW52Lk5PREVfRU5WID09PSAncHJvZHVjdGlvbicpIHtcclxuICAgICAgLy8gRmFpbCB0byB2ZXJpZnkgaW4gcHJvZHVjdGlvbiB3aXRob3V0IGEgc2VjcmV0XHJcbiAgICAgIHJldHVybiBudWxsO1xyXG4gICAgfVxyXG4gICAgLy8gSW5zZWN1cmUgZmFsbGJhY2sgZm9yIGRldmVsb3BtZW50L3Rlc3RzXHJcbiAgICBzZWNyZXQgPSAnZGV2LXNlY3JldCc7XHJcbiAgfVxyXG4gIGNvbnN0IHBhcnRzID0gY29va2llVmFsdWUuc3BsaXQoJy4nKTtcclxuICBpZiAocGFydHMubGVuZ3RoICE9PSAyKSByZXR1cm4gbnVsbDtcclxuICBjb25zdCBbZW5jb2RlZCwgc2lnXSA9IHBhcnRzO1xyXG4gIGNvbnN0IGV4cGVjdGVkID0gYXdhaXQgaG1hY1NoYTI1NkhleChlbmNvZGVkLCBzZWNyZXQpO1xyXG4gIC8vIFRpbWluZy1zYWZlIGNvbXBhcmVcclxuICB0cnkge1xyXG4gICAgLy8gTm9kZSBjcnlwdG8gdGltaW5nU2FmZUVxdWFsXHJcbiAgICAvLyBDb252ZXJ0IGhleCBzdHJpbmdzIHRvIGJ1ZmZlcnNcclxuICAgIGNvbnN0IGJ1ZkV4cGVjdGVkID0gQnVmZmVyLmZyb20oZXhwZWN0ZWQsICdoZXgnKTtcclxuICAgIGNvbnN0IGJ1ZlNpZyA9IEJ1ZmZlci5mcm9tKHNpZywgJ2hleCcpO1xyXG4gICAgaWYgKGJ1ZkV4cGVjdGVkLmxlbmd0aCAhPT0gYnVmU2lnLmxlbmd0aCkgcmV0dXJuIG51bGw7XHJcbiAgICAvLyBlc2xpbnQtZGlzYWJsZS1uZXh0LWxpbmUgQHR5cGVzY3JpcHQtZXNsaW50L25vLXZhci1yZXF1aXJlc1xyXG4gICAgY29uc3QgeyB0aW1pbmdTYWZlRXF1YWwgfSA9IHJlcXVpcmUoJ2NyeXB0bycpO1xyXG4gICAgaWYgKCF0aW1pbmdTYWZlRXF1YWwoYnVmRXhwZWN0ZWQsIGJ1ZlNpZykpIHtcclxuICAgICAgY29uc29sZS5kZWJ1ZygndmVyaWZ5U2Vzc2lvbjogdGltaW5nU2FmZUVxdWFsIGZhaWxlZCcsIHtcclxuICAgICAgICBlbmNvZGVkOiBlbmNvZGVkLnNsaWNlKDAsIDEyMCksXHJcbiAgICAgICAgcHJvdmlkZWRTaWc6IHNpZyxcclxuICAgICAgICBleHBlY3RlZFNpZzogZXhwZWN0ZWQsXHJcbiAgICAgICAgc2VjcmV0UHJlc2VudDogISFwcm9jZXNzLmVudi5TRVNTSU9OX1NFQ1JFVFxyXG4gICAgICB9KTtcclxuICAgICAgcmV0dXJuIG51bGw7XHJcbiAgICB9XHJcbiAgfSBjYXRjaCAoZSkge1xyXG4gICAgLy8gRmFsbGJhY2s6IGNvbnN0YW50LXRpbWUgc3RyaW5nIGNvbXBhcmVcclxuICAgIGxldCBtaXNtYXRjaCA9IDA7XHJcbiAgICBpZiAoZXhwZWN0ZWQubGVuZ3RoICE9PSBzaWcubGVuZ3RoKSB7XHJcbiAgICAgIGNvbnNvbGUuZGVidWcoYHZlcmlmeVNlc3Npb246IGxlbmd0aCBtaXNtYXRjaCBleHBlY3RlZD0ke2V4cGVjdGVkLmxlbmd0aH0gZ290PSR7c2lnLmxlbmd0aH0gc2VjcmV0UHJlc2VudD0keyEhcHJvY2Vzcy5lbnYuU0VTU0lPTl9TRUNSRVR9YCk7XHJcbiAgICAgIHJldHVybiBudWxsO1xyXG4gICAgfVxyXG4gICAgZm9yIChsZXQgaSA9IDA7IGkgPCBleHBlY3RlZC5sZW5ndGg7IGkrKykge1xyXG4gICAgICBtaXNtYXRjaCB8PSBleHBlY3RlZC5jaGFyQ29kZUF0KGkpIF4gc2lnLmNoYXJDb2RlQXQoaSk7XHJcbiAgICB9XHJcbiAgICBpZiAobWlzbWF0Y2ggIT09IDApIHtcclxuICAgICAgY29uc29sZS5kZWJ1ZyhgdmVyaWZ5U2Vzc2lvbjogZmFsbGJhY2sgbWlzbWF0Y2ggZXhwZWN0ZWQ9JHtleHBlY3RlZC5zbGljZSgwLDgpfSBnb3Q9JHtzaWcuc2xpY2UoMCw4KX0gc2VjcmV0UHJlc2VudD0keyEhcHJvY2Vzcy5lbnYuU0VTU0lPTl9TRUNSRVR9YCk7XHJcbiAgICAgIHJldHVybiBudWxsO1xyXG4gICAgfVxyXG4gIH1cclxuICAvLyBkZWJ1ZzogdmVyaWZpY2F0aW9uIHN1Y2NlZWRlZFxyXG4gIC8vIGNvbnNvbGUuZGVidWcoYHZlcmlmeVNlc3Npb246IG9rIGV4cGVjdGVkPSR7ZXhwZWN0ZWQuc2xpY2UoMCw4KX0gZ290PSR7c2lnLnNsaWNlKDAsOCl9YCk7XHJcbiAgdHJ5IHtcclxuICAgIGNvbnN0IHBhcnNlZCA9IEpTT04ucGFyc2UoZGVjb2RlVVJJQ29tcG9uZW50KGVuY29kZWQpKTtcclxuICAgIHJldHVybiBwYXJzZWQ7XHJcbiAgfSBjYXRjaCAoZSkge1xyXG4gICAgcmV0dXJuIG51bGw7XHJcbiAgfVxyXG59XHJcbiJdLCJ2ZXJzaW9uIjozfQ==